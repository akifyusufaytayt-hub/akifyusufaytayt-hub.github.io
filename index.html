<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
  <meta http-equiv="Pragma" content="no-cache">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Melbourne Lawn Care – Sign In</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet"/>
  <style>
    *{box-sizing:border-box} body{font-family:'Roboto',sans-serif;margin:0;background:#f5f5f5;color:#333}
    .wrap{max-width:420px;margin:6vh auto;padding:24px}
    .card{background:#fff;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,.08);padding:24px}
    h1{margin:0 0 6px;font-size:26px;color:#2e7d32}
    p.sub{margin:0 0 16px;color:#5c6b5f}
    label{display:block;margin:12px 0 6px;font-weight:600}
    input{width:100%;padding:12px 14px;border:2px solid #e4e4e4;border-radius:10px;font-size:15px;outline:none}
    input:focus{border-color:#2e7d32}
    .btn{width:100%;margin-top:16px;padding:12px;border:none;border-radius:10px;background:#2e7d32;color:#fff;font-weight:700;cursor:pointer}
    .btn:hover{background:#1b5e20}
    .muted{font-size:13px;color:#666;margin-top:10px}
    .row{display:flex;gap:10px}
    .msg{display:none;margin-bottom:14px;padding:12px;border-radius:10px;font-size:14px}
    .msg.ok{display:block;background:#d4edda;color:#155724;border:1px solid #c3e6cb}
    .msg.err{display:block;background:#f8d7da;color:#721c24;border:1px solid #f5c6cb}
    .topbar{background:#2e7d32;color:#fff;padding:14px;text-align:center}
    .foot{margin-top:18px;text-align:center;font-size:13px;color:#777}
    a{color:#2e7d32;text-decoration:none} a:hover{text-decoration:underline}
  </style>

  <!-- Firebase compat SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>
  <script>
    // Aynı config admin.html ile birebir
    const firebaseConfig = {
      apiKey: "AIzaSyDewthZGtpSgLr3P4sRBkkMt6FyvVrlT4E",
      authDomain: "lawncare-crm-b3617.firebaseapp.com",
      projectId: "lawncare-crm-b3617",
      storageBucket: "lawncare-crm-b3617.firebasestorage.app",
      messagingSenderId: "200959921459",
      appId: "1:200959921459:web:5161477d4193f96c7c0246",
      measurementId: "G-7VG6PH6N01"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db   = firebase.firestore();
  </script>
</head>
<body>
  <div class="topbar">Melbourne Lawn Care – Admin Sign In</div>

  <div class="wrap">
    <div id="status" class="msg"></div>

    <div class="card" id="login-card">
      <h1>Welcome</h1>
      <p class="sub">Sign in to manage customers, services and quotes.</p>

      <label for="email">Email</label>
      <input id="email" type="email" autocomplete="username" placeholder="you@example.com"/>

      <label for="password">Password</label>
      <input id="password" type="password" autocomplete="current-password" placeholder="••••••••"/>

      <button class="btn" id="login-btn">Sign In</button>

      <div class="muted">
        <a href="#" id="reset-link">Forgot password?</a>
      </div>

      <div class="foot">Need help? <a href="mailto:info@melbournelawncare.com.au">Contact support</a></div>
    </div>
  </div>

  <script>
    // ==== Query helpers ====
    const params = new URLSearchParams(location.search);
    const stay   = params.get('stay') === '1';

    // ==== Tek-sefer koruması ====
    let _redirected = false;

    // ==== Çıkış sonrası mesajı göster ====
    (function showSignedOutMessage(){
      const statusEl = document.getElementById('status');
      const fromAdmin = sessionStorage.getItem('loggedOut') === '1';
      const viaHash   = location.hash === '#signedout';

      if (fromAdmin || viaHash) {
        statusEl.className = 'msg ok';
        statusEl.textContent = 'You have been signed out.';
        sessionStorage.removeItem('loggedOut');
      }
    })();

    // ==== Login işlemi ====
    document.getElementById('login-btn').addEventListener('click', signIn);
    document.getElementById('password').addEventListener('keydown', e=>{
      if(e.key === 'Enter') signIn();
    });

    async function signIn(){
      const statusEl = document.getElementById('status');
      statusEl.className = 'msg'; statusEl.style.display='none';

      const email = (document.getElementById('email').value||'').trim();
      const pass  = (document.getElementById('password').value||'').trim();
      if(!email || !pass){
        statusEl.className = 'msg err';
        statusEl.textContent = 'Please enter email and password.';
        return;
      }
      try{
        await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
        await auth.signInWithEmailAndPassword(email, pass);
        // auth state change yakalayacak ve admin.html’e gönderecek (stay yoksa)
      }catch(e){
        statusEl.className = 'msg err';
        statusEl.textContent = e.message || 'Sign-in failed.';
      }
    }

    // ==== Şifre sıfırlama ====
    document.getElementById('reset-link').addEventListener('click', async (e)=>{
      e.preventDefault();
      const email = prompt('Enter your account email to receive a reset link:');
      if(!email) return;
      const statusEl = document.getElementById('status');
      try{
        await auth.sendPasswordResetEmail(email.trim());
        statusEl.className = 'msg ok';
        statusEl.textContent = 'Reset link sent. Check your inbox.';
      }catch(err){
        statusEl.className = 'msg err';
        statusEl.textContent = err.message || 'Could not send reset link.';
      }
    });

    // ==== Auth durumuna göre yönlendirme ====
    auth.onAuthStateChanged(user=>{
      // Zaten yönlendirdiysek tekrar yapma
      if (_redirected) return;

      // Kullanıcı login ise ve ?stay=1 YOKSA admin.html'e git
      if (user && !stay) {
        _redirected = true;
        // Sonsuz döngüyü engellemek için replace
        window.location.replace('admin.html');
        return;
      }

      // Kullanıcı yoksa veya stay=1 varsa form gösterilmeye devam eder
      // ekstra bir şey yapmamıza gerek yok.
    });

    // ==== Güvenlik: index’in kendini durmadan yenilemesini engelle ====
    // Eğer dış sebeple tekrar yüklense bile yeni redirect ancak onAuthStateChanged ile,
    // ve sadece user && !stay iken, bir kez gerçekleşir.
  </script>
</body>
</html>

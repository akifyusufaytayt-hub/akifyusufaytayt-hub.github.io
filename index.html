<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Melbourne Lawn Care - Professional Lawn & Garden Services</title>

<link rel="stylesheet" href="style.css" />
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
<link rel="icon" type="image/png" href="logo.png" />

<script type="application/ld+json">
{
  "@context":"https://schema.org",
  "@type":"LocalBusiness",
  "name":"Melbourne Lawn Care",
  "image":"https://www.melbournelawncare.com.au/logo.png",
  "address":{
    "@type":"PostalAddress",
    "streetAddress":"Bamford Ave, Westmeadows",
    "addressLocality":"Melbourne",
    "addressRegion":"VIC",
    "postalCode":"3049",
    "addressCountry":"AU"
  },
  "telephone":"+61478733900",
  "url":"https://www.melbournelawncare.com.au",
  "openingHours":"Mo-Sa 09:00-18:00",
  "priceRange":"$$",
  "sameAs":[
    "https://www.facebook.com/profile.php?id=61579606565810",
    "https://www.instagram.com/melbournelawncare/"
  ]
}
</script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-storage-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyDewthZGtpSgLr3P4sRBkkMt6FyvVrlT4E",
  authDomain: "lawncare-crm-b3617.firebaseapp.com",
  projectId: "lawncare-crm-b3617",
  storageBucket: "lawncare-crm-b3617.appspot.com",
  messagingSenderId: "200959921459",
  appId: "1:200959921459:web:5161477d4193f96c7c0246",
  measurementId: "G-7VG6PH6N01"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const FORM_WRITER_B64 = "eyJlbWFpbCI6ICJ3ZWJzaXRlLmZvcm1zQG1lbGJvdXJuZWxhd25jYXJlLmNvbS5hdSIsICJwYXNzd29yZCI6ICJGb3Jtc1BvcnRhbCMyMDI0In0=";
let formCreds = null;
try {
  formCreds = JSON.parse(atob(FORM_WRITER_B64));
} catch (err) {
  console.error('Form credential decode failed', err);
}
const FORM_WRITER_EMAIL = formCreds?.email || '';

let formApp = null;
if (Array.isArray(firebase.apps)) {
  for (let i = 0; i < firebase.apps.length; i += 1) {
    if (firebase.apps[i]?.name === 'formWriter') {
      formApp = firebase.apps[i];
      break;
    }
  }
}
if (!formApp) {
  formApp = firebase.initializeApp(firebaseConfig, 'formWriter');
}
const formAuth = formApp.auth();
const formDb = formApp.firestore();
const formStorage = formApp.storage();
</script>

<style id="crm-modal-css">
  .crm-modal{display:none;position:fixed;inset:0;z-index:1000;background:rgba(0,0,0,.5)}
  .crm-modal-content{background:#fff;margin:8% auto;max-width:420px;width:92%;border-radius:10px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.2)}
  .crm-modal-header{background:#2e7d32;color:#fff;padding:14px 18px;font-weight:700;display:flex;justify-content:space-between;align-items:center}
  .crm-modal-body{padding:18px}
  .crm-close{cursor:pointer;font-size:22px;opacity:.9}
  .crm-form-group{margin-bottom:12px}
  .crm-form-group label{display:block;font-size:.95rem;margin-bottom:6px}
  .crm-form-group input{width:100%;padding:10px;border:1px solid #ddd;border-radius:6px}
  .crm-login-btn{width:100%;padding:12px;border:none;border-radius:6px;background:#2e7d32;color:#fff;font-weight:700;cursor:pointer}
  .crm-error{display:none;background:#ffebee;color:#c62828;padding:10px;border-radius:6px;margin-bottom:10px;font-size:.92rem}
  .hint{color:#555;font-size:.9rem;margin-top:6px}
  .muted{color:#666}
</style>
</head>

<body>
<!-- CRM link -->
<div class="crm-toplink" aria-hidden="false">
  <a href="#" aria-label="Open CRM login">
    <i class="fas fa-user-shield" aria-hidden="true"></i> CRM
  </a>
</div>

<!-- CRM Modal -->
<div id="crm-login-modal" class="crm-modal" aria-hidden="true">
  <div class="crm-modal-content" role="dialog" aria-modal="true" aria-labelledby="crm-login-title">
    <div class="crm-modal-header">
      <span id="crm-login-title">CRM Login</span>
      <span class="crm-close" onclick="closeCRMLogin()" aria-label="Close">×</span>
    </div>
    <div class="crm-modal-body">
      <div id="crm-login-error" class="crm-error"></div>
      <form id="crm-login-form">
        <div class="crm-form-group">
          <label for="crm-email">Email</label>
          <input type="email" id="crm-email" required autocomplete="email" />
        </div>
        <div class="crm-form-group">
          <label for="crm-password">Password</label>
          <input type="password" id="crm-password" required autocomplete="current-password" />
        </div>
        <button type="submit" class="crm-login-btn">Sign In</button>
      </form>
    </div>
  </div>
</div>

<!-- Sabit telefon -->
<a href="tel:+61478733900" class="fixed-phone-btn">
  <i class="fas fa-phone"></i> +61 478 733 900
</a>

<header>
  <div class="container header-container">
    <img src="logo.png" alt="Melbourne Lawn Care Logo" class="logo" />
    <h1>Melbourne Lawn &amp; Gardening Care</h1>
    <p class="tagline">Professional Lawn Care and Gardening Services</p>
  </div>
</header>

<nav>
  <div class="container">
    <ul>
      <li><a href="#about">About</a></li>
      <li><a href="#services">Services</a></li>
      <li><a href="#quote">Get Quote</a></li>
      <li><a href="#contact">Contact</a></li>
    </ul>
  </div>
</nav>

<!-- HERO -->
<section id="hero-intro" class="section hero">
  <div class="container">
    <h2>Welcome to Melbourne's premier lawn &amp; gardening care service.<br>
    We turn ordinary yards into clean, healthy outdoor spaces.</h2>
    <p style="max-width:800px; margin:16px auto;">
      Our team works with care and a clear, organised system from start to finish.<br>
      We provide reliable, on-time service with a focus on quality and detail.
    </p>
    <p style="max-width:800px; margin:16px auto;">
      Our quote system is fair and consistent.<br>
      Prices are based on garden size, condition, and type of work — never random.<br>
      No customer pays too much or too little. Every quote reflects honest and balanced pricing.
    </p>
    <p style="max-width:800px; margin:16px auto;">
      For our regular maintenance members, we offer 10% off all ongoing services.<br>
      We value loyalty and aim to keep your garden looking its best all year round.
    </p>
  </div>
</section>

<!-- ABOUT -->
<section id="about" class="section light-bg">
  <div class="container">
    <h2>About Us</h2>
    <p style="max-width:720px;margin:0 auto 16px;">
      Melbourne Lawn & Garden Care is a trusted local business providing professional lawn mowing and garden maintenance services across Melbourne.
      We take pride in delivering reliable, friendly, and high-quality results for every customer.
    </p>
    <p style="max-width:720px;margin:0 auto 16px;">
      Our mission is simple — to keep your lawn and garden looking clean, healthy, and beautiful all year round.
      From mowing and trimming to weeding, planting, and rubbish removal, we handle every job with care and attention to detail.
    </p>
    <p style="max-width:720px;margin:0 auto;">
      No matter the size or condition of your garden, you can count on us for professional service and great results every time.
    </p>
  </div>
</section>

<!-- SERVICES -->
<section id="services" class="section">
  <div class="container">
    <h2>Services</h2>
    <p style="max-width:780px;margin:0 auto 12px;">
      We provide a wide range of lawn care and garden maintenance solutions — from mowing and trimming to planting and rubbish removal.
      Whatever your outdoor needs are, we’re here to help make your lawn and garden look their best.
    </p>

    <div class="services-grid">
      <div class="service-card"><i class="fas fa-seedling"></i><div><h3>Lawn Mowing &amp; Edging</h3></div></div>
      <div class="service-card"><i class="fas fa-scissors"></i><div><h3>Hedge Trimming</h3></div></div>
      <div class="service-card"><i class="fas fa-cut"></i><div><h3>Bush Pruning</h3></div></div>
      <div class="service-card"><i class="fas fa-broom"></i><div><h3>Weeding &amp; Garden Bed Maintenance</h3></div></div>
      <div class="service-card"><i class="fas fa-leaf"></i><div><h3>Leaves Clearing</h3></div></div>
      <div class="service-card"><i class="fas fa-spa"></i><div><h3>Ivy Trimming</h3></div></div>
      <div class="service-card"><i class="fas fa-seedling"></i><div><h3>Planting Flowers</h3></div></div>
      <div class="service-card"><i class="fas fa-trash-can"></i><div><h3>Rubbish Removal</h3></div></div>
      <div class="service-card"><i class="fas fa-water"></i><div><h3>Gutter Cleaning</h3></div></div>
    </div>
  </div>
</section>

<!-- QUOTE -->
<section id="quote" class="section">
  <div class="container">
    <h2>Request a Free Quote</h2>
    <form id="quote-form" novalidate>
      <div class="form-group"><label>Full Name</label><input type="text" name="name" required></div>
      <div class="form-group"><label>Email</label><input type="email" name="email" required></div>
      <div class="form-group"><label>Phone</label><input type="tel" name="phone" required></div>
      <div class="form-group"><label>Address</label><input type="text" name="address" required></div>

      <div class="form-group">
        <label>Photos (up to 20, optional)</label>
        <input type="file" id="quote-photo" accept="image/*" multiple data-formspree-ignore>
        <div id="upload-status" class="hint" aria-live="polite"></div>
      </div>

      <div class="form-group">
        <label>Additional Notes</label>
        <textarea name="notes" rows="4" placeholder="Please describe the work you would like done (in English)"></textarea>
      </div>

      <!-- Formspree'ye gidecek URL listeleri -->
      <input type="hidden" name="photo_urls" id="photo-urls-hidden" />

      <div id="success-message" style="display:none;margin-top:20px;text-align:center;">
        <p><strong>✅ Your request has been sent successfully!</strong></p>
        <p>We will get back to you as soon as possible.</p>
      </div>
      <div style="text-align:center;margin-top:10px">
        <button type="submit" class="btn" id="quote-submit">Get My Quote</button>
      </div>
    </form>
  </div>
</section>

<!-- CONTACT -->
<section id="contact" class="section">
  <div class="container">
    <h2>Contact Us</h2>
    <p><strong>Phone:</strong> +61 478 733 900</p>
    <p><strong>Email:</strong> <a href="mailto:melbournelawncareau@gmail.com">melbournelawncareau@gmail.com</a></p>
    <p><strong>Address:</strong> Bamford Ave, Westmeadows VIC 3049</p>
    <div class="map-container">
      <iframe title="Melbourne Lawn Care on Google Maps"
        src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d31214.494389807083!2d144.8561052750526!3d-37.68344142339905!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x6ad6e555aaaaaaa%3A0xb36bde22c6e6cd0f!2sBamford%20Ave%2C%20Westmeadows%20VIC%203049!5e0!3m2!1sen!2sau!4v1755915976310!5m2!1sen!2sau"
        allowfullscreen loading="lazy"></iframe>
    </div>
  </div>
</section>

<footer>
  <div class="container">
    <p>© 2025 Melbourne Lawn Care. All rights reserved.</p>
  </div>
</footer>

<!-- Script: CRM Modal -->
<script>
(function(){
  const link=document.querySelector('.crm-toplink a');
  const modal=document.getElementById('crm-login-modal');
  const form=document.getElementById('crm-login-form');
  const err=document.getElementById('crm-login-error');
  if(link) link.addEventListener('click',e=>{e.preventDefault();showCRMLogin();});
  if(modal) modal.addEventListener('click',e=>{if(e.target===modal)closeCRMLogin();});
  document.addEventListener('keydown',e=>{if(e.key==='Escape')closeCRMLogin();});
  if(form) form.addEventListener('submit',async e=>{
    e.preventDefault();err.style.display='none';
    try{
      const email=document.getElementById('crm-email').value.trim();
      if(email.toLowerCase()===FORM_WRITER_EMAIL.toLowerCase()){
        throw new Error('Please use your admin email to sign in.');
      }
      const pass=document.getElementById('crm-password').value;
      await auth.signInWithEmailAndPassword(email,pass);
      window.location.href='admin.html';
    }catch(ex){err.textContent=ex.message;err.style.display='block';}
  });
})();
function showCRMLogin(){const m=document.getElementById('crm-login-modal');if(m){m.style.display='block';document.body.style.overflow='hidden';}}
function closeCRMLogin(){const m=document.getElementById('crm-login-modal');if(m){m.style.display='none';document.body.style.overflow='auto';}}
</script>

<!-- Script: Formspree + Firebase Storage (multi-upload, stay on page) -->
<script>
document.addEventListener('DOMContentLoaded',()=>{
  const form=document.getElementById('quote-form');
  const msg=document.getElementById('success-message');
  const statusEl=document.getElementById('upload-status');
  const photoInput=document.getElementById('quote-photo');
  const hiddenUrls=document.getElementById('photo-urls-hidden');
  const submitBtn=document.getElementById('quote-submit');
  const FORM_STORAGE_PREFIX='quote_requests';

  function requireFormCreds(){
    if(!formCreds?.email || !formCreds?.password){
      throw new Error('Form submission is not configured.');
    }
    return formCreds;
  }

  function isPermissionDenied(err){
    if(!err) return false;
    const code=(err.code || err.error || '').toString().toLowerCase();
    if(code.includes('permission') && code.includes('denied')) return true;
    const msg=(err.message||'').toLowerCase();
    return msg.includes('missing or insufficient permissions') || msg.includes('permission denied');
  }

  function shouldFallbackToStorage(err){
    if(!err) return false;
    const code=(err.code||'').toString().toLowerCase();
    if(!code){
      const msg=(err.message||'').toLowerCase();
      if(msg.includes('quota')||msg.includes('insufficient permissions')||msg.includes('permission denied')) return true;
      if(msg.includes('unavailable')||msg.includes('deadline exceeded')||msg.includes('internal')) return true;
      return false;
    }
    if(code.includes('permission-denied')||code.includes('unauthenticated')) return true;
    if(code.includes('resource-exhausted')||code.includes('deadline-exceeded')) return true;
    if(code.includes('unavailable')||code.includes('internal')||code.includes('failed-precondition')) return true;
    if(code.includes('aborted')||code.includes('cancelled')) return true;
    return false;
  }

  function isFirebaseError(err){
    if(!err) return false;
    const name=(err.name||'').toString().toLowerCase();
    if(name.includes('firebase')) return true;
    const msg=(err.message||'').toString().toLowerCase();
    if(msg.includes('firebase:')) return true;
    if(msg.includes('firestore')) return true;
    return false;
  }

  function buildFirestoreFailureMeta(err){
    const meta={_firestoreFallback:true};
    if(isPermissionDenied(err)){
      meta._firestoreDenied=true;
    }
    const code=err?.code||err?.error;
    if(code) meta._firestoreFailedCode=code;
    const message=err?.message;
    if(message) meta._firestoreFailedMessage=message;
    return meta;
  }

  let formAuthReady=null;
  async function ensureFormAuth(){
    const creds=requireFormCreds();
    if(formAuthReady) return formAuthReady;

    formAuthReady=(async ()=>{
      try{
        await formAuth.setPersistence?.(firebase.auth.Auth.Persistence.NONE);
      }catch(_){/* ignore persistence errors */}
      const current=formAuth.currentUser;
      if(current && current.email===creds.email){
        return current;
      }
      try{
        const result=await formAuth.signInWithEmailAndPassword(creds.email,creds.password);
        return result.user;
      }catch(err){
        if(err.code==='auth/user-not-found'){
          const created=await formAuth.createUserWithEmailAndPassword(creds.email,creds.password);
          try{ await created.user.updateProfile({displayName:'Website Forms'}); }catch(_){/* ignore */}
          return created.user;
        }
        if(err.code==='auth/wrong-password'){
          const e=new Error('The embedded form password is incorrect. Please update the credentials.');
          e.original=err;
          throw e;
        }
        if(err.code==='auth/invalid-api-key' || err.code==='auth/configuration-not-found'){
          const e=new Error('Firebase configuration rejected this request. Check the API key and authorized domain list.');
          e.original=err;
          throw e;
        }
        if(err.code==='auth/operation-not-allowed'){
          const e=new Error('Email/password sign-in is disabled for this project. Enable it in Firebase Authentication settings.');
          e.original=err;
          throw e;
        }
        throw err;
      }
    })();

    try{
      const user=await formAuthReady;
      return user;
    }catch(err){
      formAuthReady=null;
      throw err;
    }
  }

  function withTimeout(promise, ms, label){
    return new Promise((resolve, reject)=>{
      let settled=false;
      const timer=setTimeout(()=>{
        if(settled) return;
        settled=true;
        reject(new Error(label||'Timed out'));
      }, ms);
      promise.then(value=>{
        if(settled) return;
        settled=true;
        clearTimeout(timer);
        resolve(value);
      }).catch(err=>{
        if(settled) return;
        settled=true;
        clearTimeout(timer);
        reject(err);
      });
    });
  }

  async function uploadAllPhotos(){
    const files=Array.from(photoInput.files||[]);
    if(!files.length) return [];
    const MAX=20; const sel=files.slice(0,MAX);

    statusEl.textContent=`Uploading ${sel.length} photo(s)...`;
    await ensureFormAuth();

    const uploads=sel.map(async (file,idx)=>{
      if(file.size>10*1024*1024) throw new Error(`File ${file.name} > 10MB`);
      const safe=file.name.replace(/[^\w.\-]+/g,'_');
      const ts=Date.now();
      const path=`quote_uploads/${ts}_${idx+1}_${safe}`;
      const ref=formStorage.ref().child(path);
      const meta={contentType:file.type, cacheControl:'public,max-age=31536000'};
      const task=ref.put(file,meta).then(s=>s.ref.getDownloadURL());
      const url=await withTimeout(task, 20000, 'Upload took too long'); // 20s
      statusEl.textContent=`Uploaded ${idx+1}/${sel.length}`;
      return url;
    });

    try{
      const urls=await Promise.all(uploads);
      statusEl.textContent=`Uploaded ${urls.length} / ${sel.length} ✓`;
      return urls;
    }catch(e){
      console.warn(e);
      statusEl.textContent='Could not upload photos, sending form without photos.';
      return [];
    }
  }

  async function saveSubmissionToStorage(data){
    await ensureFormAuth();
    const copy={...data};
    copy._storageSavedAt=new Date().toISOString();
    const fileBase=(copy.submissionKey||`wf_${Date.now()}`);
    const fileName=`${fileBase}_${Math.random().toString(36).slice(2,10)}.json`;
    const path=`${FORM_STORAGE_PREFIX}/${fileName}`;
    copy._storagePath=path;
    const json=JSON.stringify(copy);
    const ref=formStorage.ref().child(path);
    const metadata={contentType:'application/json', cacheControl:'no-store'};
    await ref.putString(json,'raw',metadata);
    return path;
  }

  form.addEventListener('submit', async (e)=>{
    e.preventDefault();               // <-- Sayfada kal
    submitBtn.disabled=true;
    statusEl.textContent='';

    try{
      const urls=await uploadAllPhotos();

      hiddenUrls.value=urls.join('\n');

      const fd=new FormData(form);
      const submissionKey=`wf-${Date.now()}-${Math.random().toString(36).slice(2,8)}`;
      const createdAtLocal=new Date().toISOString();
      const createdAtMs=Date.now();
      const basePayload={
        submissionKey,
        name:(fd.get('name')||'').toString().trim(),
        email:(fd.get('email')||'').toString().trim(),
        phone:(fd.get('phone')||'').toString().trim(),
        address:(fd.get('address')||'').toString().trim(),
        notes:(fd.get('notes')||'').toString().trim(),
        photoUrls:urls,
        photoCount:urls.length,
        createdAtLocal,
        createdAtMs,
        status:'new',
        source:'website'
      };

      await ensureFormAuth();
      let savedVia='firestore';
      try{
        const firestorePayload={...basePayload, createdAt: firebase.firestore.FieldValue.serverTimestamp()};
        await formDb.collection('quoteRequests').add(firestorePayload);
      }catch(err){
        if(shouldFallbackToStorage(err)||isFirebaseError(err)){
          console.warn('Firestore write failed, attempting storage fallback', err);
          try{
            const fallbackMeta=buildFirestoreFailureMeta(err);
            await saveSubmissionToStorage({...basePayload, ...fallbackMeta});
            savedVia='storage';
          }catch(storageErr){
            const combined=new Error(storageErr.message||'Storage fallback failed');
            combined.originalFirestoreError=err;
            combined.storageError=storageErr;
            throw combined;
          }
        }else{
          throw err;
        }
      }

      msg.style.display='block';
      form.reset();
      hiddenUrls.value='';
      statusEl.textContent=savedVia==='storage'
        ? 'Request saved successfully. Our team will review it shortly.'
        : 'Request saved successfully.';
      msg.scrollIntoView({behavior:'smooth'});
    }catch(err){
      console.error(err);
      const friendly='We could not send your request right now. Please call +61 478 733 900 or email us directly.';
      const detail=err?.message || err?.code || '';
      const message=detail ? `${friendly} (${detail})` : friendly;
      statusEl.textContent=message;
      alert(message);
    }finally{
      submitBtn.disabled=false;
    }
  });
});
</script>
</body>
</html>

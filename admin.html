<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Melbourne Lawn Care - Admin Panel</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <style>
    *{box-sizing:border-box}body{font-family:Roboto,system-ui,-apple-system,Segoe UI,Arial,sans-serif;margin:0;background:#f5f6f7;color:#223}
    header{background:#2e7d32;color:#fff;padding:14px 16px}
    header .bar{display:flex;align-items:center;gap:14px}
    header img{width:28px;height:28px}
    header h1{font-size:18px;margin:0;font-weight:700}
    .top{display:flex;gap:10px;align-items:center;margin-left:auto}
    .top .user{background:#1d5f22;padding:6px 10px;border-radius:999px;font-size:13px}
    .top button{background:#c62828;color:#fff;border:0;padding:8px 10px;border-radius:6px;cursor:pointer}
    nav{background:#225f2b;color:#cfe8d0}
    nav .tabs{display:flex;gap:8px;max-width:1200px;margin:0 auto;padding:0 12px}
    nav .tabs button{appearance:none;border:0;background:transparent;color:#cfe8d0;padding:12px 14px;cursor:pointer;border-bottom:3px solid transparent;font-weight:600}
    nav .tabs button.active{color:#fff;border-bottom-color:#fff}
    .wrap{max-width:1200px;margin:18px auto;padding:0 12px}
    .card{background:#fff;border:1px solid #e6e6e6;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,.05);margin-bottom:16px}
    .card .head{padding:12px 16px;border-bottom:1px solid #eee;font-weight:700;display:flex;justify-content:space-between;align-items:center}
    .card .body{padding:16px}
    .grid{display:grid;gap:14px}
    .grid.cols-2{grid-template-columns:repeat(auto-fit,minmax(280px,1fr))}
    .btn{background:#2e7d32;color:#fff;border:0;border-radius:8px;padding:10px 14px;cursor:pointer}
    .btn.secondary{background:#607d8b}
    .btn.danger{background:#d32f2f}
    .muted{color:#607d8b}
    .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid #e0e0e0;border-radius:999px;padding:6px 10px;background:#fafafa}
    .list{display:grid;gap:12px}
    .row{border:1px solid #e9e9e9;border-radius:10px;padding:12px;display:grid;gap:8px}
    .row .line{display:flex;gap:14px;flex-wrap:wrap;align-items:center}
    .input{display:flex;flex-direction:column;gap:6px}
    input,select,textarea{width:100%;padding:10px;border:1px solid #d5d7da;border-radius:8px;font:inherit}
    textarea{min-height:160px}
    .tag{display:inline-flex;align-items:center;gap:6px;background:#e8f5e9;border:1px solid #a5d6a7;color:#1b5e20;border-radius:999px;padding:4px 8px;font-size:12px}
    .empty{padding:12px;color:#607d8b}
    .right{margin-left:auto}
    .flex{display:flex;gap:10px;align-items:center}
    .hidden{display:none}
    /* modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:flex-start;justify-content:center;padding-top:4vh;z-index:1000}
    .modal .box{background:#fff;border-radius:12px;max-width:860px;width:92%;max-height:90vh;overflow:auto;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .box .head{position:sticky;top:0;background:#fff;z-index:2}
    .danger-link{color:#c62828;cursor:pointer}
  </style>

  <!-- Firebase compat SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDewthZGtpSgLr3P4sRBkkMt6FyvVrlT4E",
      authDomain: "lawncare-crm-b3617.firebaseapp.com",
      projectId: "lawncare-crm-b3617",
      storageBucket: "lawncare-crm-b3617.firebasestorage.app",
      messagingSenderId: "200959921459",
      appId: "1:200959921459:web:5161477d4193f96c7c0246",
      measurementId: "G-7VG6PH6N01"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db   = firebase.firestore();
  </script>
</head>
<body>

<header>
  <div class="bar">
    <img src="logo.png" alt="logo"/>
    <h1>Melbourne Lawn Care</h1>
    <span class="muted">Admin Panel - Customer Management</span>
    <div class="top">
      <span id="topUser" class="user">admin</span>
      <button id="btnLogout"><i class="fa-solid fa-right-from-bracket"></i> Çıkış Yap</button>
    </div>
  </div>
</header>

<nav>
  <div class="tabs">
    <button class="tab active" data-tab="customers"><i class="fa-solid fa-users"></i> Customers</button>
    <button class="tab" data-tab="addCustomer"><i class="fa-solid fa-user-plus"></i> Add Customer</button>
    <button class="tab" data-tab="quotes"><i class="fa-solid fa-file-invoice-dollar"></i> Quotes</button>
    <button class="tab" data-tab="services"><i class="fa-solid fa-screwdriver-wrench"></i> Services</button>
    <button class="tab" data-tab="mail"><i class="fa-solid fa-envelope"></i> Mail</button>
  </div>
</nav>

<main class="wrap">
  <!-- CUSTOMERS -->
  <section id="customers" class="card">
    <div class="head">Customer Management</div>
    <div class="body">
      <div id="customersList" class="list"></div>
    </div>
  </section>

  <!-- ADD CUSTOMER -->
  <section id="addCustomer" class="card hidden">
    <div class="head">Add Customer</div>
    <div class="body">
      <form id="customerForm" class="grid cols-2">
        <div class="input"><label>Full Name *</label><input required id="c-name"/></div>
        <div class="input"><label>Email *</label><input required type="email" id="c-email"/></div>
        <div class="input"><label>Phone *</label><input required id="c-phone"/></div>
        <div class="input"><label>Address *</label><input required id="c-address"/></div>
        <div class="input"><label>Frequency</label>
          <select id="c-frequency"><option value="">Select</option><option>weekly</option><option>fortnightly</option><option>monthly</option><option>one-off</option></select>
        </div>
        <div class="input"><label>Notes</label><textarea id="c-notes"></textarea></div>
        <div class="input"><button class="btn" type="submit">Save Customer</button></div>
      </form>
    </div>
  </section>

  <!-- QUOTES (builder mevcut haliyle – burada değişiklik yok) -->
  <section id="quotes" class="card hidden">
    <div class="head">Quotes</div>
    <div class="body">
      <div id="quoteBuilderInfo" class="empty">Quote builder with service multipliers will appear here.</div>
    </div>
  </section>

  <!-- SERVICES (sadece iskelet; mevcut veriyi bozmaz) -->
  <section id="services" class="card hidden">
    <div class="head">Services</div>
    <div class="body">
      <div class="grid cols-2">
        <div class="card">
          <div class="head">Add Service Booking</div>
          <div class="body grid">
            <div class="input"><label>Customer</label><select id="svc-customer"></select></div>
            <div class="input"><label>Service Title</label><input id="svc-title" placeholder="e.g., Fortnightly mowing"/></div>
            <div class="input"><label>Date</label><input id="svc-date" type="date"/></div>
            <div class="input"><label>Amount ($)</label><input id="svc-amount" type="number" step="0.01"/></div>
            <div><button id="svc-save" class="btn">Save Booking</button></div>
          </div>
        </div>
        <div class="card">
          <div class="head">Upcoming / Recent</div>
          <div class="body">
            <div id="svc-list" class="list"></div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- MAIL -->
  <section id="mail" class="card hidden">
    <div class="head">Mail Templates</div>
    <div class="body grid">
      <div class="grid cols-2">
        <div class="input">
          <label>Mail Type</label>
          <select id="mail-type">
            <option value="quote">Mail 1 — Quote</option>
            <option value="booking">Mail 2 — Booking</option>
            <option value="approve">Mail 3 — Approve</option>
            <option value="regular">Mail 4 — Regular Service</option>
          </select>
        </div>
        <div class="input">
          <label>Customer</label>
          <select id="mail-customer"></select>
        </div>
      </div>

      <!-- Quote seçim alanı -->
      <div id="quote-picker" class="card hidden">
        <div class="head">Select quotes to include</div>
        <div class="body" id="mail-quotes"></div>
      </div>

      <div class="grid cols-2">
        <div class="input"><label>Subject</label><input id="mail-subject"/></div>
        <div class="input"><label>Greeting (auto)</label><input id="mail-greeting"/></div>
      </div>

      <div class="input">
        <label>Mail Body</label>
        <textarea id="mail-body"></textarea>
      </div>

      <div class="flex">
        <button id="mail-copy" class="btn"><i class="fa-regular fa-copy"></i> Copy to clipboard</button>
        <span class="muted">Paste into your email client.</span>
      </div>
    </div>
  </section>
</main>

<!-- EDIT CUSTOMER MODAL -->
<div id="edit-modal" class="modal">
  <div class="box">
    <div class="head flex">
      <strong>Edit Customer</strong>
      <span class="right"></span>
      <button id="edit-close" class="btn secondary">Close</button>
    </div>
    <div class="body">
      <form id="edit-form" class="grid cols-2">
        <input type="hidden" id="e-id"/>
        <div class="input"><label>Name</label><input id="e-name"/></div>
        <div class="input"><label>Email</label><input id="e-email" type="email"/></div>
        <div class="input"><label>Phone</label><input id="e-phone"/></div>
        <div class="input"><label>Address</label><input id="e-address"/></div>
        <div class="input"><label>Frequency</label>
          <select id="e-frequency"><option value="">Select</option><option>weekly</option><option>fortnightly</option><option>monthly</option><option>one-off</option></select>
        </div>
        <div class="input" style="grid-column:1/-1"><label>Notes</label><textarea id="e-notes"></textarea></div>
        <div><button class="btn" id="e-save" type="submit">Save</button></div>
      </form>

      <div class="card" style="margin-top:10px">
        <div class="head">Quotes for this Customer</div>
        <div class="body" id="e-quotes"></div>
      </div>
    </div>
  </div>
</div>

<script>
  // ====== Auth & basic nav ======
  document.getElementById('btnLogout').onclick = ()=>auth.signOut().then(()=>location.replace('index.html'));
  auth.onAuthStateChanged(u=>{
    if(!u){location.replace('index.html');return;}
    document.getElementById('topUser').textContent = u.email||'Admin';
    // initial loads
    loadCustomers();
    fillCustomerSelects();
    loadServicesList();
  });

  // Tab switch
  document.querySelectorAll('.tab').forEach(b=>{
    b.addEventListener('click',()=>{
      document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      const id=b.dataset.tab;
      document.querySelectorAll('main section').forEach(s=>s.classList.add('hidden'));
      document.getElementById(id).classList.remove('hidden');
    });
  });

  // ====== Data caches ======
  let customersCache=[];
  let quotesCache=[];   // all quotes
  let servicesCache=[]; // bookings/services

  // ====== Customers ======
  async function loadCustomers(){
    const snap = await db.collection('musteriler').orderBy('createdAt','desc').get();
    customersCache = snap.docs.map(d=>({id:d.id,...d.data()}));
    renderCustomers();
    fillCustomerSelects();
  }
  function renderCustomers(){
    const wrap=document.getElementById('customersList');
    wrap.innerHTML='';
    if(!customersCache.length){ wrap.innerHTML='<div class="empty">No customers.</div>'; return; }
    customersCache.forEach(c=>{
      const row=document.createElement('div'); row.className='row';
      row.innerHTML=`
        <div class="line">
          <strong>${esc(c.name||'')}</strong>
          <span class="pill"><i class="fa-regular fa-envelope"></i> ${esc(c.email||'')}</span>
          <span class="pill"><i class="fa-solid fa-phone"></i> ${esc(c.phone||'')}</span>
          <span class="pill"><i class="fa-solid fa-location-dot"></i> ${esc(c.address||'')}</span>
          <span class="pill"><i class="fa-regular fa-calendar"></i> ${esc(c.frequency||'')}</span>
          <button class="btn secondary right" onclick="openEdit('${c.id}')"><i class="fa-solid fa-pen"></i> Edit</button>
        </div>`;
      wrap.appendChild(row);
    });
  }

  // Add customer
  document.getElementById('customerForm').addEventListener('submit',async(e)=>{
    e.preventDefault();
    const data={
      name:gid('c-name').value.trim(),
      email:gid('c-email').value.trim(),
      phone:gid('c-phone').value.trim(),
      address:gid('c-address').value.trim(),
      frequency:gid('c-frequency').value,
      notes:gid('c-notes').value.trim(),
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };
    await db.collection('musteriler').add(data);
    e.target.reset();
    loadCustomers();
    alert('Saved.');
  });

  // ====== Edit customer + Quotes listing/deleting ======
  const editModal = gid('edit-modal');
  gid('edit-close').onclick=()=>editModal.style.display='none';
  async function openEdit(id){
    const c=customersCache.find(x=>x.id===id);
    if(!c) return;
    gid('e-id').value=id;
    gid('e-name').value=c.name||'';
    gid('e-email').value=c.email||'';
    gid('e-phone').value=c.phone||'';
    gid('e-address').value=c.address||'';
    gid('e-frequency').value=c.frequency||'';
    gid('e-notes').value=c.notes||'';
    // load quotes of this customer
    const snap = await db.collection('teklifler').where('customerId','==',id).orderBy('createdAt','desc').get();
    const list = snap.docs.map(d=>({id:d.id,...d.data()}));
    const box = gid('e-quotes'); box.innerHTML='';
    if(!list.length){ box.innerHTML='<div class="empty">No quotes for this customer.</div>'; }
    list.forEach(q=>{
      const div=document.createElement('div'); div.className='line';
      div.innerHTML=`
        <span class="tag"><i class="fa-solid fa-receipt"></i> ${esc(q.title||'Quote')}</span>
        <span class="muted">$${Number(q.total||0).toFixed(2)}</span>
        <span class="muted">(${(q.items||[]).length} items)</span>
        <span class="right danger-link" onclick="deleteQuote('${q.id}')"><i class="fa-solid fa-trash"></i> Delete</span>`;
      box.appendChild(div);
    });
    editModal.style.display='flex';
  }
  async function deleteQuote(id){
    if(!confirm('Delete this quote?')) return;
    await db.collection('teklifler').doc(id).delete();
    // refresh both edit list & mail picker if open
    const cid = gid('e-id').value;
    if(cid) openEdit(cid);
    if(!gid('mail').classList.contains('hidden')) onMailCustomerChange();
  }
  gid('edit-form').addEventListener('submit',async(e)=>{
    e.preventDefault();
    const id=gid('e-id').value;
    const data={
      name:gid('e-name').value.trim(),
      email:gid('e-email').value.trim(),
      phone:gid('e-phone').value.trim(),
      address:gid('e-address').value.trim(),
      frequency:gid('e-frequency').value,
      notes:gid('e-notes').value.trim(),
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };
    await db.collection('musteriler').doc(id).update(data);
    await loadCustomers();
    alert('Updated.');
  });

  // ====== Services (simple list + add) ======
  function fillCustomerSelects(){
    const cSel = gid('svc-customer');
    const mSel = gid('mail-customer');
    const opts = ['<option value="">Select Customer</option>']
      .concat(customersCache.map(c=>`<option value="${c.id}">${esc(c.name||'')}</option>`));
    if(cSel) cSel.innerHTML = opts.join('');
    if(mSel) mSel.innerHTML = opts.join('');
    // auto greeting if already on Mail
    if(!gid('mail').classList.contains('hidden')) autoGreeting();
  }

  gid('svc-save').onclick = async ()=>{
    const cid = gid('svc-customer').value;
    if(!cid){ alert('Select a customer'); return; }
    const data={
      customerId: cid,
      title: gid('svc-title').value.trim() || 'Service',
      date: gid('svc-date').value || null,
      amount: Number(gid('svc-amount').value||0),
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    };
    await db.collection('hizmetler').add(data);
    gid('svc-title').value=''; gid('svc-date').value=''; gid('svc-amount').value='';
    loadServicesList();
    alert('Booking saved.');
  };

  async function loadServicesList(){
    const snap=await db.collection('hizmetler').orderBy('createdAt','desc').limit(30).get();
    servicesCache=snap.docs.map(d=>({id:d.id,...d.data()}));
    const wrap=gid('svc-list'); wrap.innerHTML='';
    if(!servicesCache.length){ wrap.innerHTML='<div class="empty">No services yet.</div>'; return; }
    servicesCache.forEach(s=>{
      const c = customersCache.find(x=>x.id===s.customerId);
      const row=document.createElement('div'); row.className='line';
      row.innerHTML=`
        <strong>${esc(s.title||'Service')}</strong>
        <span class="pill"><i class="fa-regular fa-user"></i> ${esc(c?.name||'Unknown')}</span>
        <span class="pill"><i class="fa-regular fa-calendar"></i> ${esc(s.date||'-')}</span>
        <span class="pill"><i class="fa-solid fa-dollar-sign"></i> ${Number(s.amount||0).toFixed(2)}</span>`;
      wrap.appendChild(row);
    });
  }

  // ====== Mail ======
  const mailTypeSel = gid('mail-type');
  const mailCustomerSel = gid('mail-customer');
  mailTypeSel.addEventListener('change',refreshMailTemplate);
  mailCustomerSel.addEventListener('change',()=>{onMailCustomerChange(); autoGreeting();});

  function firstNameOf(id){
    const c = customersCache.find(x=>x.id===id);
    const name = (c?.name||'').trim();
    return name.split(' ')[0]||'there';
  }
  function autoGreeting(){
    const cid = mailCustomerSel.value;
    gid('mail-greeting').value = `Hi, ${firstNameOf(cid)}`;
  }

  async function onMailCustomerChange(){
    const cid = mailCustomerSel.value;
    // load that customer's quotes
    if(!cid){ gid('quote-picker').classList.add('hidden'); return; }
    const snap = await db.collection('teklifler').where('customerId','==',cid).orderBy('createdAt','desc').get();
    const list = snap.docs.map(d=>({id:d.id,...d.data()}));
    const box = gid('mail-quotes'); box.innerHTML='';
    if(!list.length){
      box.innerHTML='<div class="empty">No quotes found for this customer.</div>';
      gid('quote-picker').classList.remove('hidden');
      return;
    }
    list.forEach(q=>{
      const id = `qpick-${q.id}`;
      const div=document.createElement('label'); div.className='line'; div.style.alignItems='center';
      div.innerHTML = `
        <input type="checkbox" id="${id}" data-title="${esc(q.title||'Quote')}" data-total="${Number(q.total||0).toFixed(2)}" style="margin-right:10px"/>
        <strong>${esc(q.title||'Quote')}</strong>
        <span class="pill"><i class="fa-solid fa-dollar-sign"></i> ${Number(q.total||0).toFixed(2)}</span>
        <span class="muted">(${(q.items||[]).length} items)</span>`;
      box.appendChild(div);
    });
    gid('quote-picker').classList.remove('hidden');
    refreshMailTemplate(); // rebuild body with selection state
    // listen changes to rebuild body quickly
    box.querySelectorAll('input[type="checkbox"]').forEach(ch=>ch.addEventListener('change',refreshMailTemplate));
  }

  function refreshMailTemplate(){
    const type = mailTypeSel.value;
    const cid  = mailCustomerSel.value;
    autoGreeting();

    if(type==='quote'){
      gid('mail-subject').value = 'Your Quote from Melbourne Lawn & Garden Care';
      // Build selected quotes table
      const picks = Array.from(gid('mail-quotes').querySelectorAll('input[type="checkbox"]:checked'))
                    .map(ch=>({title:ch.dataset.title,total:ch.dataset.total}));
      const lines = picks.length? picks.map(p=>`• ${p.title} — $${p.total}`).join('\n') : '• (select quotes above)';
      gid('mail-body').value =
`We’d be happy to help with your lawn & garden.

Here is your quote:
${lines}

If you’re happy to proceed, reply “Approve” and we’ll book you in.
Need changes? Just reply with details and we’ll update it.

Kind regards,
Melbourne Lawn & Garden Care
+61 478 733 900`;
      gid('quote-picker').classList.remove('hidden');
      return;
    }

    if(type==='booking'){
      gid('mail-subject').value='Booking Availability — Customer';
      gid('mail-body').value=
`We can schedule your lawn & garden service on the following date/time:

[your preferred date & time here]

Please let us know if this works for you. If not, feel free to suggest another time and we’ll do our best to accommodate. To confirm, please reply “Approve”.

Kind regards,
Melbourne Lawn & Garden Care
+61 478 733 900`;
      gid('quote-picker').classList.add('hidden');
      return;
    }

    if(type==='approve'){
      gid('mail-subject').value='Your Booking is Confirmed';
      gid('mail-body').value=
`Great news — your lawn & garden booking has been approved and confirmed.

If anything unexpected comes up (e.g., severe weather), we’ll contact you in advance to reschedule at a convenient time.

See you soon!

Kind regards,
Melbourne Lawn & Garden Care
+61 478 733 900`;
      gid('quote-picker').classList.add('hidden'); return;
    }

    // regular
    gid('mail-subject').value='Save 10% with Regular Service';
    gid('mail-body').value=
`We’d love to look after your lawn & garden on a regular basis.

If you choose a regular service plan (weekly/fortnightly/monthly), you’ll receive **10% off** all ongoing services, and we’ll keep your garden looking great year-round.

Reply “Regular” if you’d like to switch and we’ll set it up.

Kind regards,
Melbourne Lawn & Garden Care
+61 478 733 900`;
    gid('quote-picker').classList.add('hidden');
  }
  gid('mail-copy').onclick=()=>{
    const txt = `${gid('mail-subject').value}\n\n${gid('mail-greeting').value}\n\n${gid('mail-body').value}`;
    navigator.clipboard.writeText(txt).then(()=>alert('Copied.'));
  };

  // ===== helpers =====
  function gid(id){return document.getElementById(id)}
  function esc(s){return String(s??'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}
</script>
</body>
</html>

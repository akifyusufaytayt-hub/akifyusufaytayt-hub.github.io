<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Melbourne Lawn Care - Admin Panel</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>

  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Roboto',sans-serif;background:#f5f5f5;color:#333}
    .container{max-width:1200px;margin:0 auto;padding:0 20px}
    header{background:#2e7d32;color:#fff;text-align:center;padding:20px 0;box-shadow:0 2px 5px rgba(0,0,0,.1);position:relative}
    .header-container{display:flex;align-items:center;justify-content:center;gap:15px;position:relative}
    .logo{width:50px;height:50px;border-radius:50%}
    h1{font-size:2rem;margin:0}.tagline{font-size:1rem;opacity:.9;margin-top:5px}
    .user-section{position:absolute;right:20px;top:50%;transform:translateY(-50%);display:flex;align-items:center;gap:15px}
    .user-info{background:rgba(255,255,255,.1);padding:8px 15px;border-radius:20px;font-size:.9rem;display:flex;align-items:center;gap:8px}
    .user-info i{color:#a5d6a7}
    .logout-btn{background:linear-gradient(135deg,#f44336,#d32f2f);color:#fff;border:none;padding:10px 20px;border-radius:5px;cursor:pointer;font-size:14px;font-weight:500;transition:.3s;display:flex;align-items:center;gap:8px}
    .logout-btn:hover{background:linear-gradient(135deg,#d32f2f,#c62828);transform:translateY(-2px);box-shadow:0 5px 15px rgba(244,67,54,.3)}
    .nav-tabs{background:#fff;margin:20px 0;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.1);overflow:hidden}
    .nav-tabs ul{list-style:none;display:flex}.nav-tabs li{flex:1}
    .nav-tabs button{width:100%;padding:15px 20px;border:none;background:transparent;cursor:pointer;font-size:1rem;font-weight:500;color:#666;transition:.3s;border-bottom:3px solid transparent}
    .nav-tabs button:hover{background:#f8f9fa;color:#2e7d32}
    .nav-tabs button.active{color:#2e7d32;border-bottom-color:#2e7d32;background:#f8f9fa}
    .content-section{display:none;background:#fff;border-radius:10px;padding:30px;margin-bottom:20px;box-shadow:0 2px 10px rgba(0,0,0,.1)}
    .content-section.active{display:block}
    .content-section h2{color:#2e7d32;margin-bottom:20px;font-size:1.8rem}
    .form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin-bottom:20px}
    .form-group{margin-bottom:15px}
    .form-group label{display:block;margin-bottom:5px;font-weight:500;color:#333}
    .form-group input,.form-group select,.form-group textarea{width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:1rem;transition:border-color .3s}
    .form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:#2e7d32}
    .btn{background:#2e7d32;color:#fff;padding:12px 25px;border:none;border-radius:8px;cursor:pointer;font-size:1rem;font-weight:500;transition:.3s;margin-right:10px}
    .btn:hover{background:#1b5e20}.btn-secondary{background:#666}.btn-secondary:hover{background:#555}
    .btn-danger{background:#d32f2f}.btn-danger:hover{background:#b71c1c}
    .customer-grid{display:grid;gap:20px;margin-top:20px}
    .customer-card{background:#f8f9fa;border:1px solid #ddd;border-radius:10px;padding:20px;transition:.3s}
    .customer-card:hover{box-shadow:0 4px 15px rgba(0,0,0,.1);transform:translateY(-2px)}
    .customer-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}
    .customer-name{font-size:1.2rem;font-weight:700;color:#2e7d32;margin:0}
    .customer-actions{display:flex;gap:10px}
    .customer-info{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;margin-bottom:15px}
    .info-item{display:flex;align-items:center;gap:8px;color:#666}.info-item i{color:#2e7d32;width:16px}
    .service-history{margin-top:15px;padding-top:15px;border-top:1px solid #ddd}
    .service-item{background:#fff;padding:10px;border-radius:5px;margin-bottom:10px;border-left:4px solid #2e7d32}
    .service-date{font-weight:600;color:#2e7d32}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:30px}
    .stat-card{background:linear-gradient(135deg,#2e7d32,#4caf50);color:#fff;padding:25px;border-radius:10px;text-align:center;box-shadow:0 4px 15px rgba(46,125,50,.3)}
    .stat-number{font-size:2.5rem;font-weight:700;margin-bottom:5px}.stat-label{font-size:1rem;opacity:.9}
    .message{padding:15px;border-radius:8px;margin-bottom:20px;display:none}
    .message.success{background:#d4edda;color:#155724;border:1px solid #c3e6cb}
    .message.error{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb}
    .modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.5)}
    .modal-content{background:#fff;margin:5% auto;padding:30px;border-radius:10px;width:90%;max-width:600px;max-height:80vh;overflow-y:auto}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
    .close{font-size:24px;cursor:pointer;color:#666}.close:hover{color:#000}
    @media(max-width:768px){.container{padding:0 15px}.header-container{flex-direction:column;gap:10px}.user-section{position:static;transform:none;margin-top:15px}.nav-tabs ul{flex-direction:column}.customer-actions{flex-direction:column}.form-grid{grid-template-columns:1fr}}
  </style>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDewthZGtpSgLr3P4sRBkkMt6FyvVrlT4E",
      authDomain: "lawncare-crm-b3617.firebaseapp.com",
      projectId: "lawncare-crm-b3617",
      storageBucket: "lawncare-crm-b3617.firebasestorage.app",
      messagingSenderId: "200959921459",
      appId: "1:200959921459:web:5161477d4193f96c7c0246",
      measurementId: "G-7VG6PH6N01"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
  </script>
</head>
<body>
  <header>
    <div class="container">
      <div class="header-container">
        <img src="logo.png" alt="Melbourne Lawn Care Logo" class="logo">
        <div>
          <h1>Melbourne Lawn Care</h1>
          <p class="tagline">Admin Panel - Customer Management</p>
        </div>
        <div class="user-section">
          <div class="user-info">
            <i class="fas fa-user-circle"></i>
            <span id="current-user-display">Admin</span>
          </div>
          <button onclick="logout()" class="logout-btn">
            <i class="fas fa-sign-out-alt"></i> Çıkış Yap
          </button>
        </div>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="nav-tabs">
      <ul>
        <li><button class="nav-btn active" data-section="dashboard"><i class="fas fa-chart-line"></i> Dashboard</button></li>
        <li><button class="nav-btn" data-section="customers"><i class="fas fa-users"></i> Customers</button></li>
        <li><button class="nav-btn" data-section="add-customer"><i class="fas fa-user-plus"></i> Add Customer</button></li>
        <li><button class="nav-btn" data-section="quotes"><i class="fas fa-file-invoice-dollar"></i> Quotes</button></li>
      </ul>
    </div>

    <div id="message" class="message"></div>

    <!-- Dashboard -->
    <div id="dashboard" class="content-section active">
      <h2><i class="fas fa-chart-line"></i> Dashboard</h2>
      <div class="stats-grid">
        <div class="stat-card"><div class="stat-number" id="total-customers">0</div><div class="stat-label">Total Customers</div></div>
        <div class="stat-card"><div class="stat-number" id="total-services">0</div><div class="stat-label">Total Services</div></div>
        <div class="stat-card"><div class="stat-number" id="monthly-revenue">$0</div><div class="stat-label">This Month Revenue</div></div>
        <div class="stat-card"><div class="stat-number" id="avg-service-value">$0</div><div class="stat-label">Avg Service Value</div></div>
      </div>
      <div style="background:#fff;padding:20px;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.1);">
        <h3 style="color:#2e7d32;margin-bottom:15px;">Recent Activities</h3>
        <div id="recent-activities"></div>
      </div>
    </div>

    <!-- Customers -->
    <div id="customers" class="content-section">
      <h2><i class="fas fa-users"></i> Customers</h2>
      <div id="customers-list" class="customer-grid"></div>
    </div>

    <!-- Add Customer -->
    <div id="add-customer" class="content-section">
      <h2><i class="fas fa-user-plus"></i> Add New Customer</h2>
      <form id="customer-form">
        <div class="form-grid">
          <div>
            <div class="form-group"><label>Full Name *</label><input id="customer-name" required></div>
            <div class="form-group"><label>Email *</label><input type="email" id="customer-email" required></div>
            <div class="form-group"><label>Phone *</label><input id="customer-phone" required></div>
            <div class="form-group"><label>Address *</label><input id="customer-address" required></div>
          </div>
          <div>
            <div class="form-group"><label>Postcode</label><input id="customer-postcode"></div>
            <div class="form-group"><label>Lawn Size</label>
              <select id="lawn-size"><option value="">Select</option><option>Small</option><option>Medium</option><option>Large</option></select>
            </div>
            <div class="form-group"><label>Frequency</label>
              <select id="service-frequency"><option value="">Select</option><option>Weekly</option><option>Fortnightly</option><option>Monthly</option><option>One-off</option></select>
            </div>
            <div class="form-group"><label>Notes</label><textarea id="customer-notes" rows="3"></textarea></div>
          </div>
        </div>
        <button type="submit" class="btn"><i class="fas fa-save"></i> Save</button>
      </form>
    </div>

    <!-- Quotes -->
    <div id="quotes" class="content-section">
      <h2><i class="fas fa-file-invoice-dollar"></i> Create Quote</h2>
      <p>Quote builder with service multipliers will appear here.</p>
    </div>
  </div>

  <script>
    // === Auth kontrolü ===
    let _redirectOnce = false;
    auth.onAuthStateChanged(async user=>{
      if(_redirectOnce) return;
      if(!user){
        _redirectOnce = true;
        window.location.replace('login.html?stay=1#login');
        return;
      }
      document.getElementById('current-user-display').textContent = user.email || 'Admin';
      await loadCustomers();
      updateDashboard();
    });

    // === Logout ===
    function logout(){
      auth.signOut().then(()=>{
        sessionStorage.setItem('loggedOut','1');
        window.location.replace('login.html?stay=1#signedout');
      }).catch(e=>alert('Logout failed: '+e.message));
    }

    // === Basit veri fonksiyonları ===
    const dbRef = db.collection('musteriler');
    let customersCache = [];

    document.getElementById('customer-form').addEventListener('submit',async e=>{
      e.preventDefault();
      const c={
        name:val('customer-name'),
        email:val('customer-email'),
        phone:val('customer-phone'),
        address:val('customer-address'),
        postcode:val('customer-postcode'),
        lawnSize:val('lawn-size'),
        frequency:val('service-frequency'),
        notes:val('customer-notes'),
        createdAt:firebase.firestore.FieldValue.serverTimestamp()
      };
      await dbRef.add(c);
      showMessage('Customer added successfully','success');
      e.target.reset();
      loadCustomers();
      updateDashboard();
    });

    function val(id){return document.getElementById(id)?.value||'';}
    function showMessage(t,type){
      const el=document.getElementById('message');
      el.textContent=t;el.className=`message ${type}`;el.style.display='block';
      setTimeout(()=>el.style.display='none',3000);
    }

    async function loadCustomers(){
      const snap=await dbRef.orderBy('createdAt','desc').get();
      customersCache=snap.docs.map(d=>({id:d.id,...d.data()}));
      renderCustomers();
    }

    function renderCustomers(){
      const wrap=document.getElementById('customers-list');
      if(!customersCache.length){wrap.innerHTML='<p>No customers yet.</p>';return;}
      wrap.innerHTML=customersCache.map(c=>`
        <div class="customer-card">
          <div class="customer-header"><h3>${esc(c.name)}</h3></div>
          <div class="customer-info">
            <div class="info-item"><i class="fas fa-envelope"></i>${esc(c.email)}</div>
            <div class="info-item"><i class="fas fa-phone"></i>${esc(c.phone)}</div>
            <div class="info-item"><i class="fas fa-map-marker-alt"></i>${esc(c.address)}</div>
          </div>
        </div>`).join('');
    }

    function updateDashboard(){
      document.getElementById('total-customers').textContent=customersCache.length;
    }

    document.querySelectorAll('.nav-btn').forEach(btn=>btn.addEventListener('click',()=>{
      document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
      document.querySelectorAll('.content-section').forEach(s=>s.classList.remove('active'));
      btn.classList.add('active');
      document.getElementById(btn.dataset.section).classList.add('active');
    }));

    function esc(s){return String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));}
  </script>
</body>
</html>

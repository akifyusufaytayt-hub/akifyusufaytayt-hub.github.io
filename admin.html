<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Melbourne Lawn Care - Sign In</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet"/>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:'Roboto',sans-serif;background:#f5f5f5;color:#333;min-height:100vh;display:flex;align-items:center;justify-content:center}
    .card{width:100%;max-width:420px;background:#fff;border-radius:14px;padding:28px;box-shadow:0 10px 30px rgba(0,0,0,.08)}
    h1{font-size:1.6rem;color:#2e7d32;margin-bottom:6px}
    p.sub{color:#666;margin-bottom:18px}
    .form-group{margin:12px 0}
    label{display:block;font-weight:600;margin-bottom:6px}
    input{width:100%;padding:12px 14px;border:2px solid #e6e6e6;border-radius:10px;font-size:1rem;transition:border .2s}
    input:focus{outline:none;border-color:#2e7d32}
    button{width:100%;padding:12px 16px;border:none;border-radius:10px;background:#2e7d32;color:#fff;font-weight:600;cursor:pointer;transition:transform .05s}
    button:hover{transform:translateY(-1px)}
    .row{display:flex;gap:10px;margin-top:10px}
    .muted{color:#777;font-size:.9rem;margin-top:10px;text-align:center}
    .msg{display:none;margin-top:10px;padding:10px;border-radius:8px;font-size:.95rem}
    .msg.error{display:block;background:#f8d7da;color:#721c24;border:1px solid #f5c6cb}
    .msg.success{display:block;background:#d4edda;color:#155724;border:1px solid #c3e6cb}
    .brand{display:flex;align-items:center;gap:10px;margin-bottom:16px}
    .brand img{width:44px;height:44px;border-radius:50%}
    .center{text-align:center}
    a{color:#2e7d32;text-decoration:none}
    a:hover{text-decoration:underline}
  </style>

  <!-- Firebase compat SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDewthZGtpSgLr3P4sRBkkMt6FyvVrlT4E",
      authDomain: "lawncare-crm-b3617.firebaseapp.com",
      projectId: "lawncare-crm-b3617",
      storageBucket: "lawncare-crm-b3617.firebasestorage.app",
      messagingSenderId: "200959921459",
      appId: "1:200959921459:web:5161477d4193f96c7c0246",
      measurementId: "G-7VG6PH6N01"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
  </script>
</head>
<body>
  <div class="card">
    <div class="brand">
      <img src="logo.png" alt="Logo">
      <div>
        <h1>Melbourne Lawn Care</h1>
        <p class="sub">Admin Sign In</p>
      </div>
    </div>

    <div id="state-msg" class="msg"></div>

    <form id="login-form">
      <div class="form-group">
        <label for="email">Email</label>
        <input id="email" type="email" autocomplete="username" required/>
      </div>
      <div class="form-group">
        <label for="password">Password</label>
        <input id="password" type="password" autocomplete="current-password" required/>
      </div>
      <button type="submit">Sign In</button>
    </form>

    <div class="row">
      <button id="signup-btn" title="Create an account">Create Account</button>
      <button id="reset-btn" class="secondary" title="Send reset email">Reset Password</button>
    </div>

    <p class="muted">Need help? <a href="mailto:info@melbournelawncare.com.au">Contact support</a></p>
  </div>

  <script>
    // ---------- Redirect Logic (loop guard) ----------
    let _indexRedirectedOnce = false;

    auth.onAuthStateChanged(user => {
      if (_indexRedirectedOnce) return;

      // Eğer admin'den 'logout' ile geldiysek, bu sayfada kal ve bayrağı temizle
      if (sessionStorage.getItem('loggedOut') === '1') {
        sessionStorage.removeItem('loggedOut');
        // user varsa bile bu yüklemede redirect yapma:
        if (user) {
          // İsteğe bağlı: bilgi mesajı
          showMsg('Signed out successfully.', 'success');
        }
        return;
      }

      if (user) {
        _indexRedirectedOnce = true;
        // Girişli kullanıcıyı tek seferde admin'e at
        window.location.replace('admin.html');
      }
    });

    // ---------- UI Helpers ----------
    const stateMsg = document.getElementById('state-msg');
    function showMsg(text, type='error'){
      stateMsg.textContent = text;
      stateMsg.className = 'msg ' + type;
      stateMsg.style.display = 'block';
    }

    // ---------- Auth Actions ----------
    document.getElementById('login-form').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const email = document.getElementById('email').value.trim();
      const pass  = document.getElementById('password').value;
      try{
        await auth.signInWithEmailAndPassword(email, pass);
        // onAuthStateChanged admin.html'e yönlendirecek
      }catch(err){
        showMsg(err.message || 'Sign in failed.');
      }
    });

    document.getElementById('signup-btn').addEventListener('click', async ()=>{
      const email = document.getElementById('email').value.trim();
      const pass  = document.getElementById('password').value;
      if(!email || !pass){ showMsg('Enter email and password to create account.'); return; }
      try{
        await auth.createUserWithEmailAndPassword(email, pass);
        // onAuthStateChanged yönlendirir
      }catch(err){
        showMsg(err.message || 'Sign up failed.');
      }
    });

    document.getElementById('reset-btn').addEventListener('click', async ()=>{
      const email = document.getElementById('email').value.trim();
      if(!email){ showMsg('Enter your email to receive reset link.'); return; }
      try{
        await auth.sendPasswordResetEmail(email);
        showMsg('Reset email sent. Check your inbox.', 'success');
      }catch(err){
        showMsg(err.message || 'Could not send reset email.');
      }
    });
  </script>
</body>
</html>

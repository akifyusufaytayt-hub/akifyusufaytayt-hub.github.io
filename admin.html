<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Melbourne Lawn Care - Admin Panel</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>

  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Roboto',sans-serif;background:#f5f5f5;color:#333}
    .container{max-width:1200px;margin:0 auto;padding:0 20px}
    header{background:#2e7d32;color:#fff;text-align:center;padding:20px 0;box-shadow:0 2px 5px rgba(0,0,0,.1);position:relative}
    .header-container{display:flex;align-items:center;justify-content:center;gap:15px;position:relative}
    .logo{width:50px;height:50px;border-radius:50%}
    h1{font-size:2rem;margin:0}.tagline{font-size:1rem;opacity:.9;margin-top:5px}
    .user-section{position:absolute;right:20px;top:50%;transform:translateY(-50%);display:flex;align-items:center;gap:15px}
    .user-info{background:rgba(255,255,255,.1);padding:8px 15px;border-radius:20px;font-size:.9rem;display:flex;align-items:center;gap:8px}
    .user-info i{color:#a5d6a7}
    .logout-btn{background:linear-gradient(135deg,#f44336,#d32f2f);color:#fff;border:none;padding:10px 20px;border-radius:5px;cursor:pointer;font-size:14px;font-weight:500;transition:.3s;display:flex;align-items:center;gap:8px}
    .logout-btn:hover{background:linear-gradient(135deg,#d32f2f,#c62828);transform:translateY(-2px);box-shadow:0 5px 15px rgba(244,67,54,.3)}

    .nav-tabs{background:#fff;margin:20px 0;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.1);overflow:hidden}
    .nav-tabs ul{list-style:none;display:flex;flex-wrap:wrap}
    .nav-tabs li{flex:1}
    .nav-tabs button{width:100%;padding:15px 20px;border:none;background:transparent;cursor:pointer;font-size:1rem;font-weight:500;color:#666;transition:.3s;border-bottom:3px solid transparent}
    .nav-tabs button:hover{background:#f8f9fa;color:#2e7d32}
    .nav-tabs button.active{color:#2e7d32;border-bottom-color:#2e7d32;background:#f8f9fa}

    .content-section{display:none;background:#fff;border-radius:10px;padding:30px;margin-bottom:20px;box-shadow:0 2px 10px rgba(0,0,0,.1)}
    .content-section.active{display:block}
    .content-section h2{color:#2e7d32;margin-bottom:20px;font-size:1.8rem}

    .form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin-bottom:20px}
    .form-group{margin-bottom:15px}
    .form-group label{display:block;margin-bottom:5px;font-weight:500;color:#333}
    .form-group input,.form-group select,.form-group textarea{width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:1rem;transition:border-color .3s}
    .form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:#2e7d32}
    .btn{background:#2e7d32;color:#fff;padding:12px 25px;border:none;border-radius:8px;cursor:pointer;font-size:1rem;font-weight:500;transition:.3s;margin-right:10px}
    .btn:hover{background:#1b5e20}.btn-secondary{background:#666}.btn-secondary:hover{background:#555}
    .btn-danger{background:#d32f2f}.btn-danger:hover{background:#b71c1c}
    .btn-ghost{background:#fff;border:1px solid #ddd;color:#333}
    .btn-ghost:hover{background:#f6f6f6}

    .customer-grid{display:grid;gap:20px;margin-top:20px}
    .customer-card{background:#f8f9fa;border:1px solid #ddd;border-radius:10px;padding:20px;transition:.3s}
    .customer-card:hover{box-shadow:0 4px 15px rgba(0,0,0,.1);transform:translateY(-2px)}
    .customer-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}
    .customer-name{font-size:1.2rem;font-weight:700;color:#2e7d32;margin:0}
    .customer-actions{display:flex;gap:10px}
    .customer-info{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;margin-bottom:15px}
    .info-item{display:flex;align-items:center;gap:8px;color:#666}
    .info-item i{color:#2e7d32;width:16px}

    .service-history{margin-top:15px;padding-top:15px;border-top:1px solid #ddd}
    .service-item{background:#fff;padding:10px;border-radius:5px;margin-bottom:10px;border-left:4px solid #2e7d32}
    .service-date{font-weight:600;color:#2e7d32}

    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:30px}
    .stat-card{background:linear-gradient(135deg,#2e7d32,#4caf50);color:#fff;padding:25px;border-radius:10px;text-align:center;box-shadow:0 4px 15px rgba(46,125,50,.3)}
    .stat-number{font-size:2.5rem;font-weight:700;margin-bottom:5px}.stat-label{font-size:1rem;opacity:.9}

    .message{padding:15px;border-radius:8px;margin-bottom:20px;display:none}
    .message.success{background:#d4edda;color:#155724;border:1px solid #c3e6cb}
    .message.error{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb}

    .modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.5)}
    .modal-content{background:#fff;margin:5% auto;padding:30px;border-radius:10px;width:90%;max-width:900px;max-height:80vh;overflow-y:auto}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .close{font-size:24px;cursor:pointer;color:#666}.close:hover{color:#000}
    .split-2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .muted{color:#777}
    .chip{display:inline-block;background:#e8f5e9;border:1px solid #a5d6a7;color:#2e7d32;padding:2px 8px;border-radius:12px;font-size:.85rem}
    .quote-row{background:#fff;border:1px solid #eee;border-left:4px solid #2e7d32;border-radius:8px;padding:8px 10px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;gap:12px}

    /* edit services grid inside modal */
    .svc-row{display:grid;grid-template-columns:130px 1fr 120px 1fr auto;gap:8px;align-items:center;background:#fafafa;border:1px solid #eee;border-radius:8px;padding:8px;margin-bottom:8px}
    .svc-row input{width:100%;padding:8px;border:1.5px solid #ddd;border-radius:6px}
    .svc-actions{display:flex;gap:6px;justify-content:flex-end}
    @media(max-width:920px){ .svc-row{grid-template-columns:1fr 1fr} }
    @media(max-width:768px){
      .container{padding:0 15px}
      .header-container{flex-direction:column;gap:10px}
      .user-section{position:static;transform:none;margin-top:15px}
      .nav-tabs ul{flex-direction:column}
      .customer-actions{flex-direction:column}
      .form-grid{grid-template-columns:1fr}
      .split-2{grid-template-columns:1fr}
    }
  </style>

  <!-- Firebase compat SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDewthZGtpSgLr3P4sRBkkMt6FyvVrlT4E",
      authDomain: "lawncare-crm-b3617.firebaseapp.com",
      projectId: "lawncare-crm-b3617",
      storageBucket: "lawncare-crm-b3617.firebasestorage.app",
      messagingSenderId: "200959921459",
      appId: "1:200959921459:web:5161477d4193f96c7c0246",
      measurementId: "G-7VG6PH6N01"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
  </script>
</head>
<body>
  <header>
    <div class="container">
      <div class="header-container">
        <img src="logo.png" alt="Melbourne Lawn Care Logo" class="logo">
        <div>
          <h1>Melbourne Lawn Care</h1>
          <p class="tagline">Admin Panel - Customer Management</p>
        </div>
        <div class="user-section">
          <div class="user-info">
            <i class="fas fa-user-circle"></i>
            <span id="current-user-display">Admin</span>
          </div>
          <button onclick="logout()" class="logout-btn">
            <i class="fas fa-sign-out-alt"></i> Çıkış Yap
          </button>
        </div>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="nav-tabs">
      <ul>
        <li><button class="nav-btn" data-section="dashboard"><i class="fas fa-chart-line"></i> Dashboard</button></li>
        <li><button class="nav-btn active" data-section="customers"><i class="fas fa-users"></i> Customers</button></li>
        <li><button class="nav-btn" data-section="add-customer"><i class="fas fa-user-plus"></i> Add Customer</button></li>
        <li><button class="nav-btn" data-section="services"><i class="fas fa-briefcase"></i> Services</button></li>
        <li><button class="nav-btn" data-section="quotes"><i class="fas fa-file-invoice-dollar"></i> Quotes</button></li>
      </ul>
    </div>

    <div id="message" class="message"></div>

    <!-- DASHBOARD -->
    <div id="dashboard" class="content-section">
      <h2><i class="fas fa-chart-line"></i> Dashboard</h2>
      <div class="stats-grid">
        <div class="stat-card"><div class="stat-number" id="total-customers">0</div><div class="stat-label">Total Customers</div></div>
        <div class="stat-card"><div class="stat-number" id="total-services">0</div><div class="stat-label">Total Services</div></div>
        <div class="stat-card"><div class="stat-number" id="monthly-revenue">$0</div><div class="stat-label">This Month Revenue</div></div>
        <div class="stat-card"><div class="stat-number" id="avg-service-value">$0</div><div class="stat-label">Avg Service Value</div></div>
      </div>
      <div style="background:#fff;padding:20px;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.1);">
        <h3 style="color:#2e7d32;margin-bottom:15px;">Recent Activities</h3>
        <div id="recent-activities"></div>
      </div>
    </div>

    <!-- CUSTOMERS -->
    <div id="customers" class="content-section active">
      <h2><i class="fas fa-users"></i> Customer Management</h2>
      <div id="customers-list" class="customer-grid"></div>
    </div>

    <!-- ADD CUSTOMER -->
    <div id="add-customer" class="content-section">
      <h2><i class="fas fa-user-plus"></i> Add New Customer</h2>
      <form id="customer-form">
        <div class="form-grid">
          <div>
            <div class="form-group"><label for="customer-name">Full Name *</label><input type="text" id="customer-name" name="name" required></div>
            <div class="form-group"><label for="customer-email">Email *</label><input type="email" id="customer-email" name="email" required></div>
            <div class="form-group"><label for="customer-phone">Phone *</label><input type="tel" id="customer-phone" name="phone" required></div>
            <div class="form-group"><label for="customer-address">Address *</label><input type="text" id="customer-address" name="address" required></div>
          </div>
          <div>
            <div class="form-group"><label for="customer-postcode">Postcode</label><input type="text" id="customer-postcode" name="postcode"></div>
            <div class="form-group"><label for="lawn-size">Lawn Size</label>
              <select id="lawn-size" name="lawnSize">
                <option value="">Select Size</option>
                <option value="small">Small (up to 300m²)</option>
                <option value="medium">Medium (300-600m²)</option>
                <option value="large">Large (600m²+)</option>
              </select>
            </div>
            <div class="form-group"><label for="service-frequency">Service Frequency</label>
              <select id="service-frequency" name="frequency">
                <option value="">Select Frequency</option>
                <option value="weekly">Weekly</option>
                <option value="fortnightly">Fortnightly</option>
                <option value="monthly">Monthly</option>
                <option value="one-off">One-off</option>
              </select>
            </div>
            <div class="form-group"><label for="customer-notes">Notes</label><textarea id="customer-notes" name="notes" rows="3" placeholder="Special instructions, gate access, etc."></textarea></div>
          </div>
        </div>
        <button type="submit" class="btn"><i class="fas fa-save"></i> Save Customer</button>
        <button type="button" class="btn btn-secondary" onclick="clearForm()"><i class="fas fa-times"></i> Clear Form</button>
      </form>
    </div>

    <!-- SERVICES -->
    <div id="services" class="content-section">
      <h2><i class="fas fa-briefcase"></i> Services</h2>
      <form id="service-form">
        <div class="form-grid">
          <div>
            <div class="form-group">
              <label>Customer *</label>
              <select id="service-customer" required>
                <option value="">Select Customer</option>
              </select>
            </div>
            <div class="form-group">
              <label>Service Type *</label>
              <input id="service-type" placeholder="e.g., Lawn Mowing" required>
            </div>
          </div>
          <div>
            <div class="form-group">
              <label>Date *</label>
              <input id="service-date" type="date" required>
            </div>
            <div class="form-group">
              <label>Amount (AUD) *</label>
              <input id="service-amount" type="number" step="0.01" min="0" placeholder="e.g., 120" required>
            </div>
          </div>
        </div>
        <div class="form-group">
          <label>Notes</label>
          <textarea id="service-notes" rows="3" placeholder="Optional notes"></textarea>
        </div>
        <button type="submit" class="btn"><i class="fas fa-save"></i> Save Service</button>
        <button type="button" class="btn btn-secondary" onclick="document.getElementById('service-form').reset()">Clear</button>
      </form>

      <div style="margin-top:20px;">
        <h3 style="color:#2e7d32;margin-bottom:10px;">Recent Services</h3>
        <div id="services-recent"></div>
      </div>
    </div>

    <!-- QUOTES -->
    <div id="quotes" class="content-section">
      <h2><i class="fas fa-file-invoice-dollar"></i> Create Quote</h2>

      <div class="customer-card" style="margin-bottom:16px;">
        <div class="customer-info" style="align-items:flex-end;">
          <div class="info-item" style="flex:1 1 280px;">
            <i class="fas fa-user"></i>
            <span style="width:100%;">
              <label style="display:block;font-weight:600;">Customer</label>
              <select id="quote-customer" style="width:100%;">
                <option value="">Select Customer</option>
              </select>
            </span>
          </div>
          <div class="info-item" style="flex:2 1 420px;">
            <i class="fas fa-heading"></i>
            <span style="width:100%;">
              <label style="display:block;font-weight:600;">Quote Title (optional)</label>
              <input type="text" id="quote-title" placeholder="e.g., Regular mowing + hedging (Fortnightly)"/>
            </span>
          </div>
          <div class="info-item" style="flex:0 0 auto;gap:10px;">
            <button class="btn" id="add-line-btn"><i class="fas fa-plus"></i> Add Service</button>
            <button class="btn btn-secondary" id="clear-quote-btn"><i class="fas fa-eraser"></i> Clear</button>
          </div>
        </div>
      </div>

      <div id="quote-lines" class="customer-grid"></div>

      <div class="customer-card" style="margin-top:20px;">
        <div class="customer-header">
          <h3 class="customer-name">Totals</h3>
        </div>
        <div class="customer-info">
          <div class="info-item"><i class="fas fa-receipt"></i><span>Subtotal: $<span id="q-subtotal">0.00</span></span></div>
          <div class="info-item"><i class="fas fa-percent"></i><span>GST (10%): $<span id="q-gst">0.00</span></span></div>
          <div class="info-item"><i class="fas fa-dollar-sign"></i><span><strong>Total: $<span id="q-total">0.00</span></strong></span></div>
        </div>
        <div style="margin-top:12px;">
          <button class="btn" id="save-quote-btn"><i class="fas fa-save"></i> Save Quote</button>
        </div>
        <div id="quote-save-msg" class="message" style="margin-top:12px;"></div>
      </div>
    </div>
  </div>

  <!-- MODAL -->
  <div id="customer-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modal-customer-name"></h3>
        <span class="close" onclick="closeModal()">&times;</span>
      </div>

      <!-- View mode -->
      <div id="modal-view">
        <div class="split-2">
          <div>
            <p><strong>Email:</strong> <span id="m-email" class="muted"></span></p>
            <p><strong>Phone:</strong> <span id="m-phone" class="muted"></span></p>
            <p><strong>Address:</strong> <span id="m-address" class="muted"></span></p>
          </div>
          <div>
            <p><strong>Frequency:</strong> <span id="m-frequency" class="muted"></span></p>
            <p><strong>Lawn Size:</strong> <span id="m-lawn" class="muted"></span></p>
            <p><strong>Postcode:</strong> <span id="m-postcode" class="muted"></span></p>
          </div>
        </div>
        <p style="margin-top:8px;"><strong>Notes:</strong> <span id="m-notes" class="muted"></span></p>

        <h4 style="margin:14px 0;color:#2e7d32;">Quotes</h4>
        <div id="modal-quotes"></div>

        <h4 style="margin:14px 0;color:#2e7d32;">Service History</h4>
        <div id="modal-services"></div>

        <div style="margin-top:14px;">
          <button class="btn" id="edit-btn"><i class="fas fa-pen"></i> Edit Customer</button>
        </div>
      </div>

      <!-- Edit mode -->
      <div id="modal-edit" style="display:none;">
        <form id="edit-form">
          <div class="form-grid">
            <div>
              <div class="form-group"><label>Full Name</label><input id="e-name" required></div>
              <div class="form-group"><label>Email</label><input id="e-email" type="email" required></div>
              <div class="form-group"><label>Phone</label><input id="e-phone" required></div>
              <div class="form-group"><label>Address</label><input id="e-address" required></div>
            </div>
            <div>
              <div class="form-group"><label>Postcode</label><input id="e-postcode"></div>
              <div class="form-group"><label>Lawn Size</label>
                <select id="e-lawn">
                  <option value="">Select Size</option>
                  <option value="small">Small</option>
                  <option value="medium">Medium</option>
                  <option value="large">Large</option>
                </select>
              </div>
              <div class="form-group"><label>Frequency</label>
                <select id="e-frequency">
                  <option value="">Select Frequency</option>
                  <option value="weekly">Weekly</option>
                  <option value="fortnightly">Fortnightly</option>
                  <option value="monthly">Monthly</option>
                  <option value="one-off">One-off</option>
                </select>
              </div>
              <div class="form-group"><label>Notes</label><textarea id="e-notes" rows="3"></textarea></div>
            </div>
          </div>

          <div style="margin:8px 0 14px;">
            <h4 style="color:#2e7d32;margin-bottom:8px;">Quotes (delete)</h4>
            <div id="e-quotes"></div>
          </div>

          <div style="margin:8px 0 14px;">
            <h4 style="color:#2e7d32;margin-bottom:8px;">Services (edit / delete)</h4>
            <div id="e-services"></div>
          </div>

          <div>
            <button type="submit" class="btn"><i class="fas fa-save"></i> Save</button>
            <button type="button" class="btn btn-secondary" onclick="toggleEdit(false)"><i class="fas fa-times"></i> Cancel</button>
          </div>
        </form>
      </div>

    </div>
  </div>

  <script>
    // ===== Redirect guards =====
    let _redirectedOnce = false;

    auth.onAuthStateChanged(async user=>{
      if (_redirectedOnce) return;
      if (!user) { _redirectedOnce = true; window.location.replace('index.html'); return; }

      document.getElementById('current-user-display').textContent = user.email || 'Admin';
      await loadCustomers();
      await loadServices();
      await loadQuotes();
      updateDashboard();
      updateAllCustomerDropdowns();
    });

    function logout(){
      auth.signOut()
        .then(()=>{ sessionStorage.setItem('loggedOut','1'); window.location.replace('index.html'); })
        .catch(err=>alert('Logout failed: '+err.message));
    }

    // ====== UI: Tabs ======
    document.querySelectorAll('.nav-btn').forEach(b=>b.addEventListener('click',()=>showSection(b.dataset.section)));
    function showSection(id){
      document.querySelectorAll('.content-section').forEach(s=>s.classList.remove('active'));
      document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      document.querySelector(`.nav-btn[data-section="${id}"]`).classList.add('active');
      if(id==='quotes') initQuotesUI();
    }

    function showMessage(text,type){const el=document.getElementById('message');el.textContent=text;el.className=`message ${type}`;el.style.display='block';setTimeout(()=>el.style.display='none',3000);}

    // ====== Data caches ======
    let customersCache = [];
    let servicesCache = [];
    let quotesCache = [];

    // ===== Small helpers =====
    function esc(str){return String(str).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}
    function val(id){return (document.getElementById(id)?.value||'').trim();}
    function setV(id,v){const el=document.getElementById(id); if(el) el.value=v||'';}
    function formatTs(ts){ if(!ts) return ''; try{ const d=ts.toDate(); return d.toLocaleString(); }catch(_){ return ''; } }

    // ===== Customers =====
    document.addEventListener('submit',e=>{
      if(e.target && e.target.id === 'customer-form'){ e.preventDefault(); saveCustomer(); }
      if(e.target && e.target.id === 'edit-form'){ e.preventDefault(); saveCustomerEdits(); }
      if(e.target && e.target.id === 'service-form'){ e.preventDefault(); saveService(); }
    });

    async function saveCustomer(){
      const data={
        name:val('customer-name'),email:val('customer-email'),phone:val('customer-phone'),
        address:val('customer-address'),postcode:val('customer-postcode'),
        lawnSize:val('lawn-size'),frequency:val('service-frequency'),notes:val('customer-notes'),
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      await db.collection('musteriler').add(data);
      showMessage('Customer added successfully!','success');
      clearForm();
      await loadCustomers(); await loadQuotes();
      updateDashboard(); updateAllCustomerDropdowns();
    }

    function clearForm(){ document.getElementById('customer-form').reset(); }

    async function loadCustomers(){
      const snap=await db.collection('musteriler').orderBy('createdAt','desc').get();
      customersCache=snap.docs.map(d=>({id:d.id,...d.data()}));
      renderCustomers(customersCache);
    }

    function countCustomerQuotes(customerId){ return quotesCache.filter(q=>q.customerId===customerId).length; }
    function latestQuoteFor(customerId){
      const q=quotesCache.filter(x=>x.customerId===customerId)
        .sort((a,b)=> (b.createdAt?.toMillis?.()||0) - (a.createdAt?.toMillis?.()||0) )[0];
      return q;
    }

    function renderCustomers(list){
      const wrap=document.getElementById('customers-list');wrap.innerHTML='';
      if(!list.length){wrap.innerHTML='<p style="text-align:center;color:#666;padding:40px;">No customers found. Add your first customer to get started!</p>';return;}
      list.forEach(c=>wrap.appendChild(createCustomerCard(c)));
    }

    function createCustomerCard(c){
      const cServices=servicesCache.filter(s=>s.customerId===c.id);
      const totalServices=cServices.length;
      const totalRevenue=cServices.reduce((sum,s)=>sum+(parseFloat(s.amount)||0),0);
      const lastService=cServices.sort((a,b)=>new Date(b.date)-new Date(a.date))[0];
      const qCount=countCustomerQuotes(c.id);
      const lastQuote=latestQuoteFor(c.id);

      const card=document.createElement('div');card.className='customer-card';
      card.innerHTML=`
        <div class="customer-header">
          <h3 class="customer-name">${esc(c.name||'')}</h3>
          <div class="customer-actions">
            <button class="btn" title="View Details" onclick="viewCustomer('${c.id}')"><i class="fas fa-eye"></i></button>
            <button class="btn btn-secondary" title="Edit" onclick="openEditCustomer('${c.id}')"><i class="fas fa-pen"></i></button>
          </div>
        </div>
        <div class="customer-info">
          <div class="info-item"><i class="fas fa-envelope"></i><span>${esc(c.email||'')}</span></div>
          <div class="info-item"><i class="fas fa-phone"></i><span>${esc(c.phone||'')}</span></div>
          <div class="info-item"><i class="fas fa-map-marker-alt"></i><span>${esc(c.address||'')}</span></div>
          <div class="info-item"><i class="fas fa-calendar"></i><span>${esc(c.frequency||'Not set')}</span></div>
          <div class="info-item"><i class="fas fa-file-invoice-dollar"></i><span>Quotes: <span class="chip">${qCount}</span></span></div>
          <div class="info-item"><i class="fas fa-chart-line"></i><span>${totalServices} services</span></div>
          <div class="info-item"><i class="fas fa-dollar-sign"></i><span>$${totalRevenue.toFixed(2)} total</span></div>
        </div>
        ${ lastQuote ? `
          <div class="service-history">
            <strong>Latest Quote:</strong>
            <div class="quote-row">
              <div><b>${esc(lastQuote.title||'Quote')}</b> • $${Number(lastQuote.total||0).toFixed(2)}</div>
              <div class="muted">${formatTs(lastQuote.createdAt)}</div>
            </div>
          </div>` : ``}
        ${ lastService ? `
          <div class="service-history">
            <strong>Last Service:</strong>
            <div class="service-item">
              <span class="service-date">${esc(lastService.date||'')}</span> •
              <span>${esc(lastService.type||'')}</span> •
              <span>$${Number(lastService.amount||0).toFixed(2)}</span>
            </div>
          </div>` : ``}
      `;
      return card;
    }

    // ===== Modal view / edit =====
    let modalCustomerId = null;

    function viewCustomer(id){
      modalCustomerId=id;
      const c=customersCache.find(x=>x.id===id);if(!c)return;
      toggleEdit(false);

      // Fill view
      document.getElementById('modal-customer-name').textContent=c.name||'Customer';
      document.getElementById('m-email').textContent=c.email||'';
      document.getElementById('m-phone').textContent=c.phone||'';
      document.getElementById('m-address').textContent=c.address||'';
      document.getElementById('m-frequency').textContent=c.frequency||'';
      document.getElementById('m-lawn').textContent=c.lawnSize||'';
      document.getElementById('m-postcode').textContent=c.postcode||'';
      document.getElementById('m-notes').textContent=c.notes||'';

      // Quotes list
      const qWrap=document.getElementById('modal-quotes');
      const cQuotes=quotesCache
        .filter(q=>q.customerId===id)
        .sort((a,b)=> (b.createdAt?.toMillis?.()||0) - (a.createdAt?.toMillis?.()||0));
      qWrap.innerHTML= cQuotes.length
        ? cQuotes.map(q=>`<div class="quote-row"><div><b>${esc(q.title||'Quote')}</b> • $${Number(q.total||0).toFixed(2)}</div><div class="muted">${formatTs(q.createdAt)}</div></div>`).join('')
        : '<p class="muted">No quotes yet.</p>';

      // Services history
      const sWrap=document.getElementById('modal-services');
      const cServices=servicesCache.filter(s=>s.customerId===id).sort((a,b)=>new Date(b.date)-new Date(a.date));
      sWrap.innerHTML = cServices.length
        ? cServices.map(s=>`<div class="service-item"><span class="service-date">${esc(s.date||'')}</span> • <span>${esc(s.type||'')}</span> • <span>$${Number(s.amount||0).toFixed(2)}</span></div>`).join('')
        : '<p class="muted">No services yet.</p>';

      document.getElementById('customer-modal').style.display='block';
      window.onclick=(e)=>{if(e.target===document.getElementById('customer-modal'))closeModal();};
      document.onkeydown=(e)=>{if(e.key==='Escape')closeModal();};

      document.getElementById('edit-btn').onclick=()=>openEditCustomer(id);
    }

    function openEditCustomer(id){
      modalCustomerId=id;
      const c=customersCache.find(x=>x.id===id); if(!c) return;
      toggleEdit(true);
      // Fill edit form
      setV('e-name',c.name||''); setV('e-email',c.email||''); setV('e-phone',c.phone||''); setV('e-address',c.address||'');
      setV('e-postcode',c.postcode||''); setV('e-lawn',c.lawnSize||''); setV('e-frequency',c.frequency||''); setV('e-notes',c.notes||'');
      document.getElementById('modal-customer-name').textContent = (c.name||'Customer') + ' — Edit';
      // Quotes (with delete)
      renderEditQuotes();
      // Services (edit/delete)
      renderEditServices();
      document.getElementById('customer-modal').style.display='block';
    }

    function renderEditQuotes(){
      const wrap=document.getElementById('e-quotes');
      const cQuotes=quotesCache
        .filter(q=>q.customerId===modalCustomerId)
        .sort((a,b)=> (b.createdAt?.toMillis?.()||0) - (a.createdAt?.toMillis?.()||0));
      wrap.innerHTML = cQuotes.length
        ? cQuotes.map(q=>`
            <div class="quote-row">
              <div><b>${esc(q.title||'Quote')}</b> • $${Number(q.total||0).toFixed(2)} <span class="muted">(${formatTs(q.createdAt)})</span></div>
              <div>
                <button class="btn btn-danger btn-ghost" onclick="deleteQuote('${q.id}')">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>`).join('')
        : '<p class="muted">No quotes for this customer.</p>';
    }

    async function deleteQuote(quoteId){
      if(!confirm('Delete this quote?')) return;
      await db.collection('teklifler').doc(quoteId).delete();
      await loadQuotes();
      renderEditQuotes();
      renderCustomers(customersCache);
      showMessage('Quote deleted.','success');
    }

    function renderEditServices(){
      const wrap=document.getElementById('e-services');
      const list = servicesCache
        .filter(s=>s.customerId===modalCustomerId)
        .sort((a,b)=> new Date(b.date) - new Date(a.date));
      if(!list.length){ wrap.innerHTML = '<p class="muted">No services for this customer.</p>'; return; }

      wrap.innerHTML = list.map(s=>`
        <div class="svc-row" id="svc-${s.id}">
          <input type="date" id="svdate-${s.id}" value="${esc(s.date||'')}" />
          <input type="text" id="svtype-${s.id}" placeholder="Type" value="${esc(s.type||'')}" />
          <input type="number" id="svamt-${s.id}" step="0.01" min="0" value="${Number(s.amount||0).toFixed(2)}" />
          <input type="text" id="svnote-${s.id}" placeholder="Notes" value="${esc(s.notes||'')}" />
          <div class="svc-actions">
            <button class="btn btn-ghost" title="Save" onclick="saveServiceEdit('${s.id}')"><i class="fas fa-save"></i></button>
            <button class="btn btn-danger btn-ghost" title="Delete" onclick="deleteServiceItem('${s.id}')"><i class="fas fa-trash"></i></button>
          </div>
        </div>
      `).join('');
    }

    async function saveServiceEdit(serviceId){
      const date  = document.getElementById(`svdate-${serviceId}`).value.trim();
      const type  = document.getElementById(`svtype-${serviceId}`).value.trim();
      const amount= parseFloat(document.getElementById(`svamt-${serviceId}`).value||'0');
      const notes = document.getElementById(`svnote-${serviceId}`).value.trim();

      if(!date || !type || isNaN(amount)){ showMessage('Please fill required service fields.','error'); return; }

      await db.collection('hizmetler').doc(serviceId).update({
        date, type, amount, notes,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });

      await loadServices();
      renderEditServices();
      renderCustomers(customersCache);
      updateDashboard();
      showMessage('Service updated.','success');
    }

    async function deleteServiceItem(serviceId){
      if(!confirm('Delete this service?')) return;
      await db.collection('hizmetler').doc(serviceId).delete();
      await loadServices();
      renderEditServices();
      renderCustomers(customersCache);
      updateDashboard();
      showMessage('Service deleted.','success');
    }

    function toggleEdit(isEdit){
      document.getElementById('modal-view').style.display = isEdit ? 'none' : 'block';
      document.getElementById('modal-edit').style.display = isEdit ? 'block' : 'none';
    }

    function closeModal(){
      const m=document.getElementById('customer-modal');
      m.style.display='none';
      window.onclick=null; document.onkeydown=null;
      modalCustomerId=null;
    }

    // ===== Services (tab) =====
    async function loadServices(){
      const snap=await db.collection('hizmetler').orderBy('createdAt','desc').limit(200).get();
      servicesCache=snap.docs.map(d=>({id:d.id,...d.data()}));
      renderRecentServices();
      renderCustomers(customersCache);
    }

    function renderRecentServices(){
      const act=document.getElementById('recent-activities');
      if(act){
        const latest=[...servicesCache].slice(0,5).map(s=>{
          const c=customersCache.find(x=>x.id===s.customerId);
          return `<div>- ${esc(s.date||'')} • ${esc(s.type||'')} • ${esc(c?.name||'Unknown')} • $${Number(s.amount||0).toFixed(2)}</div>`;
        }).join('');
        act.innerHTML=latest||'<p>No recent activity.</p>';
      }

      const list=document.getElementById('services-recent');
      if(list){
        const items=[...servicesCache].slice(0,12).map(s=>{
          const c=customersCache.find(x=>x.id===s.customerId);
          return `<div class="service-item"><span class="service-date">${esc(s.date||'')}</span> • <b>${esc(s.type||'')}</b> • ${esc(c?.name||'Unknown')} • $${Number(s.amount||0).toFixed(2)}</div>`;
        }).join('');
        list.innerHTML=items||'<p class="muted">No services recorded.</p>';
      }
      updateDashboard();
    }

    async function saveService(){
      const customerId=val('service-customer');
      const type=val('service-type');
      const date=val('service-date');
      const amount=parseFloat(val('service-amount')||'0');
      const notes=val('service-notes');

      if(!customerId || !type || !date || isNaN(amount)){ showMessage('Please fill all required fields.','error'); return; }

      await db.collection('hizmetler').add({
        customerId, type, date, amount, notes,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });

      showMessage('Service saved.','success');
      document.getElementById('service-form').reset();
      await loadServices();
      renderCustomers(customersCache);
    }

    function updateDashboard(){
      const tc=document.getElementById('total-customers'); if(tc) tc.textContent=customersCache.length;
      const ts=document.getElementById('total-services'); if(ts) ts.textContent=servicesCache.length;

      const now=new Date(); const ym=d=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
      const thisMonth=ym(now);
      const monthServices=servicesCache.filter(s=>s.date && ym(new Date(s.date))===thisMonth);
      const monthRevenue=monthServices.reduce((sum,s)=>sum+(parseFloat(s.amount)||0),0);
      const avg=servicesCache.length?servicesCache.reduce((sum,s)=>sum+(parseFloat(s.amount)||0),0)/servicesCache.length:0;

      const mr=document.getElementById('monthly-revenue'); if(mr) mr.textContent=`$${monthRevenue.toFixed(2)}`;
      const av=document.getElementById('avg-service-value'); if(av) av.textContent=`$${avg.toFixed(2)}`;
    }

    // ===== Quotes (builder) - Qty yok =====
    let pricingData=null;
    let quoteLines=[];

    async function loadQuotes(){
      const snap=await db.collection('teklifler').orderBy('createdAt','desc').get();
      quotesCache=snap.docs.map(d=>({id:d.id,...d.data()}));
      renderCustomers(customersCache);
    }

    async function loadPricingData(){
      if(pricingData) return pricingData;
      try{
        const res=await fetch('services_pricing.json',{cache:'no-store'});
        pricingData=await res.json();
      }catch(e){
        alert('Pricing JSON (services_pricing.json) yüklenemedi. Dosyayı projenin köküne ekleyin.');
        pricingData={};
      }
      return pricingData;
    }

    function initQuotesUI(){
      updateAllCustomerDropdowns();
      const addBtn=document.getElementById('add-line-btn');
      const clearBtn=document.getElementById('clear-quote-btn');
      const saveBtn=document.getElementById('save-quote-btn');
      if(addBtn) addBtn.onclick=addQuoteLine;
      if(clearBtn) clearBtn.onclick=clearQuote;
      if(saveBtn) saveBtn.onclick=saveQuote;
    }

    function updateAllCustomerDropdowns(){
      const opts = '<option value="">Select Customer</option>' +
                   customersCache.map(c=>`<option value="${c.id}">${esc(c.name||'')}</option>`).join('');
      const selQ=document.getElementById('quote-customer'); if(selQ){ const cur=selQ.value; selQ.innerHTML=opts; if(cur) selQ.value=cur; }
      const selS=document.getElementById('service-customer'); if(selS){ const cur=selS.value; selS.innerHTML=opts; if(cur) selS.value=cur; }
    }

    async function addQuoteLine(){
      await loadPricingData();
      const wrap=document.getElementById('quote-lines');
      const idx=quoteLines.length;

      const services=Object.keys(pricingData||{});
      if(!services.length){ alert('Servis listesi boş. services_pricing.json içeriğini kontrol edin.'); return; }
      const defaultService=services[0];

      const line={service:defaultService,size:'',multipliers:{},unit:0,total:0};
      quoteLines.push(line);

      const card=document.createElement('div');
      card.className='customer-card';
      card.dataset.idx=idx;
      card.innerHTML=`
        <div class="customer-header">
          <h3 class="customer-name">Service #${idx+1}</h3>
          <div class="customer-actions">
            <button class="btn btn-danger" title="Remove" onclick="removeQuoteLine(${idx})"><i class="fas fa-trash"></i></button>
          </div>
        </div>
        <div class="customer-info">
          <div class="info-item" style="flex:1 1 260px;">
            <i class="fas fa-tools"></i>
            <span>
              <label style="display:block;font-weight:600;">Service</label>
              <select onchange="onServiceChange(${idx}, this.value)">${services.map(s=>`<option value="${esc(s)}">${esc(s)}</option>`).join('')}</select>
            </span>
          </div>
          <div class="info-item" style="flex:1 1 220px;">
            <i class="fas fa-ruler-combined"></i>
            <span>
              <label style="display:block;font-weight:600;">Size</label>
              <select id="q-size-${idx}" onchange="onSizeChange(${idx}, this.value)"></select>
            </span>
          </div>
          <div class="info-item" style="flex:2 1 320px;">
            <i class="fas fa-sliders-h"></i>
            <span>
              <label style="display:block;font-weight:600;">Difficulty / Extras</label>
              <div id="q-mults-${idx}" style="display:flex;flex-wrap:wrap;gap:8px;"></div>
            </span>
          </div>
          <div class="info-item" style="flex:0 0 160px;">
            <i class="fas fa-dollar-sign"></i>
            <span>Unit: $<span id="q-unit-${idx}">0.00</span></span>
          </div>
          <div class="info-item" style="flex:0 0 170px;">
            <i class="fas fa-file-invoice-dollar"></i>
            <span><strong>Total: $<span id="q-line-total-${idx}">0.00</span></strong></span>
          </div>
        </div>`;
      wrap.appendChild(card);
      populateSizesAndMultipliers(idx, defaultService);
      recalcQuote();
    }

    function onServiceChange(idx, service){
      quoteLines[idx].service=service;
      quoteLines[idx].size='';
      quoteLines[idx].multipliers={};
      populateSizesAndMultipliers(idx, service);
      recalcQuote();
    }

    function populateSizesAndMultipliers(idx, service){
      const data=(pricingData||{})[service]||{};
      const rows=(data.rows||[]);
      const sizeSel=document.getElementById(`q-size-${idx}`);
      const multWrap=document.getElementById(`q-mults-${idx}`);

      sizeSel.innerHTML=`<option value="">Select Size</option>`+rows.map(r=>`<option value="${esc(r.size)}">${esc(r.size)}</option>`).join('');

      const multCols=(data.multipliers||[]);
      multWrap.innerHTML=multCols.map(col=>{
        const id=`q-m-${idx}-${col.replace(/\s+/g,'_')}`;
        return `
          <label style="display:inline-flex;gap:6px;align-items:center;border:1px solid #ddd;padding:6px 10px;border-radius:16px;">
            <input type="checkbox" id="${id}" onchange="onMultiplierToggle(${idx}, '${col}', this.checked)"/>
            <span>${esc(col)}</span>
          </label>`;
      }).join('');
    }

    function onSizeChange(idx,size){ quoteLines[idx].size=size; recalcQuote(); }
    function onMultiplierToggle(idx,col,checked){ quoteLines[idx].multipliers[col]=!!checked; recalcQuote(); }

    function removeQuoteLine(idx){
      const card=document.querySelector(`.customer-card[data-idx="${idx}"]`);
      if(card) card.remove();
      quoteLines[idx]=null;
      recalcQuote();
    }

    function calcLine(idx){
      const line=quoteLines[idx]; if(!line) return {unit:0,total:0};
      const data=(pricingData||{})[line.service]||{};
      const rows=data.rows||[];
      const row=rows.find(r=>String(r.size)===String(line.size));
      if(!row) return {unit:0,total:0};

      let unit=Number(row.base)||0;
      const m=line.multipliers||{};
      for(const col of (data.multipliers||[])){
        if(m[col]){
          const val=(row.multipliers && row.multipliers[col]!=null) ? Number(row.multipliers[col]) : 1;
          unit*= (val || 1);
        }
      }
      const total = unit; // Qty kaldırıldı

      const uEl=document.getElementById(`q-unit-${idx}`);
      const tEl=document.getElementById(`q-line-total-${idx}`);
      if(uEl) uEl.textContent=unit.toFixed(2);
      if(tEl) tEl.textContent=total.toFixed(2);

      line.unit=unit; line.total=total;
      return {unit,total};
    }

    function recalcQuote(){
      let subtotal=0;
      quoteLines.forEach((_,i)=>{ if(quoteLines[i]) subtotal+= calcLine(i).total; });
      const gst=subtotal*0.10;
      const grand=subtotal+gst;
      document.getElementById('q-subtotal').textContent=subtotal.toFixed(2);
      document.getElementById('q-gst').textContent=gst.toFixed(2);
      document.getElementById('q-total').textContent=grand.toFixed(2);
    }

    function clearQuote(){ quoteLines=[]; document.getElementById('quote-lines').innerHTML=''; recalcQuote(); }

    async function saveQuote(){
      const customerId=document.getElementById('quote-customer').value;
      if(!customerId){ showQuoteMsg('Select a customer.','error'); return; }
      const items=quoteLines.filter(Boolean).map((ln,i)=>({
        idx:i+1, service:ln.service, size:ln.size,
        multipliers:Object.keys(ln.multipliers||{}).filter(k=>ln.multipliers[k]),
        unit:Number(ln.unit||0), total:Number(ln.total||0)
      }));
      if(!items.length){ showQuoteMsg('Add at least one service.','error'); return; }

      const subtotal=Number(document.getElementById('q-subtotal').textContent||'0');
      const gst=Number(document.getElementById('q-gst').textContent||'0');
      const total=Number(document.getElementById('q-total').textContent||'0');
      const customer=customersCache.find(c=>c.id===customerId);
      const title=(document.getElementById('quote-title').value||'').trim();

      const doc={
        customerId, customerName: customer?.name || '',
        title: title || `Quote for ${customer?.name||''}`,
        items, subtotal, gst, total,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        pricingVersion: 'services_pricing.json'
      };

      try{
        const ref=await db.collection('teklifler').add(doc);
        showQuoteMsg(`Quote saved. ID: ${ref.id}`,'success');
        await loadQuotes();
        await loadCustomers();
      }catch(e){
        console.error(e);
        showQuoteMsg('Save failed.','error');
      }
    }

    function showQuoteMsg(text,type){
      const el=document.getElementById('quote-save-msg');
      el.textContent=text; el.className=`message ${type}`; el.style.display='block';
      setTimeout(()=>el.style.display='none',4000);
    }
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Melbourne Lawn Care - Admin Panel</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>

  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Roboto',sans-serif;background:#f5f5f5;color:#333}
    .container{max-width:1200px;margin:0 auto;padding:0 20px}
    header{background:#2e7d32;color:#fff;text-align:center;padding:20px 0;box-shadow:0 2px 5px rgba(0,0,0,.1);position:relative}
    .header-container{display:flex;align-items:center;justify-content:center;gap:15px;position:relative}
    .logo{width:50px;height:50px;border-radius:50%}
    h1{font-size:2rem;margin:0}.tagline{font-size:1rem;opacity:.9;margin-top:5px}
    .user-section{position:absolute;right:20px;top:50%;transform:translateY(-50%);display:flex;align-items:center;gap:15px}
    .user-info{background:rgba(255,255,255,.1);padding:8px 15px;border-radius:20px;font-size:.9rem;display:flex;align-items:center;gap:8px}
    .logout-btn{background:linear-gradient(135deg,#f44336,#d32f2f);color:#fff;border:none;padding:10px 20px;border-radius:5px;cursor:pointer;font-size:14px;font-weight:500}

    .nav-tabs{background:#fff;margin:20px 0;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.1);overflow:hidden}
    .nav-tabs ul{list-style:none;display:flex}.nav-tabs li{flex:1}
    .nav-tabs button{width:100%;padding:15px 20px;border:none;background:transparent;cursor:pointer;font-size:1rem;font-weight:500;color:#666;transition:.3s;border-bottom:3px solid transparent}
    .nav-tabs button.active{color:#2e7d32;border-bottom-color:#2e7d32;background:#f8f9fa}

    .content-section{display:none;background:#fff;border-radius:10px;padding:30px;margin-bottom:20px;box-shadow:0 2px 10px rgba(0,0,0,.1)}
    .content-section.active{display:block}
    .content-section h2{color:#2e7d32;margin-bottom:20px;font-size:1.8rem}

    .form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin-bottom:20px}
    .form-group{margin-bottom:15px}
    .form-group label{display:block;margin-bottom:5px;font-weight:500;color:#333}
    .form-group input,.form-group select,.form-group textarea{width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:1rem}

    .btn{background:#2e7d32;color:#fff;padding:12px 25px;border:none;border-radius:8px;cursor:pointer;font-size:1rem;font-weight:500;margin-right:10px}
    .btn-ghost{background:#edf2ee;color:#2e7d32;border:1px solid #cfe3d1}
    .btn-danger{background:#d32f2f;color:#fff}

    .customer-grid{display:grid;gap:20px;margin-top:20px}
    .customer-card{background:#f8f9fa;border:1px solid #ddd;border-radius:10px;padding:20px}
    .customer-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}
    .customer-info{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;margin-bottom:15px}
    .info-item{display:flex;align-items:center;gap:8px;color:#666}
    .info-item i{color:#2e7d32;width:16px}

    /* Mail quotes pills */
    #quote-item-list .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid #ddd;padding:8px 12px;border-radius:20px;background:#fff}
    #quote-item-list .pill input{transform:translateY(1px)}
    .muted{color:#777;font-size:.95rem}
  </style>

  <!-- Firebase compat SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDewthZGtpSgLr3P4sRBkkMt6FyvVrlT4E",
      authDomain: "lawncare-crm-b3617.firebaseapp.com",
      projectId: "lawncare-crm-b3617",
      storageBucket: "lawncare-crm-b3617.firebasestorage.app",
      messagingSenderId: "200959921459",
      appId: "1:200959921459:web:5161477d4193f96c7c0246",
      measurementId: "G-7VG6PH6N01"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
  </script>
</head>
<body>
  <header>
    <div class="container">
      <div class="header-container">
        <img src="logo.png" alt="Melbourne Lawn Care Logo" class="logo">
        <div>
          <h1>Melbourne Lawn Care</h1>
          <p class="tagline">Admin Panel - Customer Management</p>
        </div>
        <div class="user-section">
          <div class="user-info">
            <i class="fas fa-user-circle"></i>
            <span id="current-user-display">Admin</span>
          </div>
          <button onclick="logout()" class="logout-btn">
            <i class="fas fa-sign-out-alt"></i> Çıkış Yap
          </button>
        </div>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="nav-tabs">
      <ul>
        <li><button class="nav-btn active" data-section="dashboard"><i class="fas fa-chart-line"></i> Dashboard</button></li>
        <li><button class="nav-btn" data-section="customers"><i class="fas fa-users"></i> Customers</button></li>
        <li><button class="nav-btn" data-section="add-customer"><i class="fas fa-user-plus"></i> Add Customer</button></li>
        <li><button class="nav-btn" data-section="services"><i class="fas fa-wrench"></i> Services</button></li>
        <li><button class="nav-btn" data-section="quotes"><i class="fas fa-file-invoice-dollar"></i> Quotes</button></li>
        <li><button class="nav-btn" data-section="mail"><i class="fas fa-envelope"></i> Mail</button></li>
      </ul>
    </div>

    <div id="message" class="message"></div>

    <!-- DASHBOARD -->
    <div id="dashboard" class="content-section active">
      <h2><i class="fas fa-chart-line"></i> Dashboard</h2>
      <div id="recent-activities"></div>
    </div>

    <!-- CUSTOMERS -->
    <div id="customers" class="content-section">
      <h2><i class="fas fa-users"></i> Customer Management</h2>
      <div id="customers-list" class="customer-grid"></div>
    </div>

    <!-- ADD CUSTOMER -->
    <div id="add-customer" class="content-section">
      <h2><i class="fas fa-user-plus"></i> Add New Customer</h2>
      <form id="customer-form">
        <div class="form-grid">
          <div>
            <div class="form-group"><label>Full Name *</label><input id="customer-name" required></div>
            <div class="form-group"><label>Email *</label><input id="customer-email" type="email" required></div>
            <div class="form-group"><label>Phone *</label><input id="customer-phone" required></div>
            <div class="form-group"><label>Address *</label><input id="customer-address" required></div>
          </div>
          <div>
            <div class="form-group"><label>Postcode</label><input id="customer-postcode"></div>
            <div class="form-group"><label>Lawn Size</label>
              <select id="lawn-size">
                <option value="">Select Size</option>
                <option value="small">Small (up to 300m²)</option>
                <option value="medium">Medium (300–600m²)</option>
                <option value="large">Large (600m²+)</option>
              </select>
            </div>
            <div class="form-group"><label>Service Frequency</label>
              <select id="service-frequency">
                <option value="">Select Frequency</option>
                <option value="weekly">Weekly</option>
                <option value="fortnightly">Fortnightly</option>
                <option value="monthly">Monthly</option>
                <option value="one-off">One-off</option>
              </select>
            </div>
            <div class="form-group"><label>Notes</label><textarea id="customer-notes" rows="3"></textarea></div>
          </div>
        </div>
        <button type="submit" class="btn"><i class="fas fa-save"></i> Save Customer</button>
        <button type="button" class="btn btn-ghost" onclick="clearForm()">Clear</button>
      </form>
    </div>

    <!-- SERVICES (unchanged UI) -->
    <div id="services" class="content-section">
      <h2><i class="fas fa-wrench"></i> Services</h2>
      <div id="services-log"></div>
    </div>

    <!-- QUOTES (unchanged UI) -->
    <div id="quotes" class="content-section">
      <h2><i class="fas fa-file-invoice-dollar"></i> Create Quote</h2>
      <div class="customer-card" style="margin-bottom:16px;">
        <div class="customer-info" style="align-items:flex-end;">
          <div class="info-item" style="flex:1 1 280px;">
            <i class="fas fa-user"></i>
            <span style="width:100%;">
              <label style="display:block;font-weight:600;">Customer</label>
              <select id="quote-customer" style="width:100%;">
                <option value="">Select Customer</option>
              </select>
            </span>
          </div>
          <div class="info-item" style="flex:2 1 420px;">
            <i class="fas fa-heading"></i>
            <span style="width:100%;">
              <label style="display:block;font-weight:600;">Quote Title (optional)</label>
              <input id="quote-title" placeholder="e.g., Regular mowing + hedging (Fortnightly)"/>
            </span>
          </div>
          <div class="info-item" style="flex:0 0 auto;gap:10px;">
            <button class="btn" id="add-line-btn"><i class="fas fa-plus"></i> Add Service</button>
            <button class="btn btn-ghost" id="clear-quote-btn"><i class="fas fa-eraser"></i> Clear</button>
          </div>
        </div>
      </div>
      <div id="quote-lines" class="customer-grid"></div>
      <div class="customer-card" style="margin-top:20px;">
        <div class="customer-header"><h3 class="customer-name">Totals</h3></div>
        <div class="customer-info">
          <div class="info-item"><i class="fas fa-receipt"></i><span>Subtotal: $<span id="q-subtotal">0.00</span></span></div>
          <div class="info-item"><i class="fas fa-percent"></i><span>GST (10%): $<span id="q-gst">0.00</span></span></div>
          <div class="info-item"><i class="fas fa-dollar-sign"></i><span><strong>Total: $<span id="q-total">0.00</span></strong></span></div>
        </div>
        <div style="margin-top:12px;"><button class="btn" id="save-quote-btn"><i class="fas fa-save"></i> Save Quote</button></div>
        <div id="quote-save-msg" class="message" style="margin-top:12px;"></div>
      </div>
    </div>

    <!-- MAIL (the ONLY section changed) -->
    <div id="mail" class="content-section">
      <h2><i class="fas fa-envelope"></i> Mail Templates</h2>

      <div class="customer-card" style="margin-bottom:16px;">
        <div class="customer-info" style="align-items:flex-end;">
          <div class="info-item" style="flex:0 0 220px;">
            <i class="fas fa-layer-group"></i>
            <span style="width:100%;">
              <label style="display:block;font-weight:600;">Mail Type</label>
              <select id="mail-type">
                <option value="quote">Mail 1 — Quote</option>
                <option value="booking">Mail 2 — Booking</option>
                <option value="approve">Mail 3 — Approve</option>
                <option value="regular">Mail 4 — Regular Service</option>
              </select>
            </span>
          </div>

          <div class="info-item" style="flex:1 1 320px;">
            <i class="fas fa-user"></i>
            <span style="width:100%;">
              <label style="display:block;font-weight:600;">Customer</label>
              <select id="mail-customer">
                <option value="">Select Customer</option>
              </select>
            </span>
          </div>

          <div class="info-item" id="mail-date-wrap" style="flex:0 0 260px; display:none;">
            <i class="fas fa-calendar-alt"></i>
            <span style="width:100%;">
              <label style="display:block;font-weight:600;">Booking Date / Time</label>
              <input id="mail-date" placeholder="e.g., Tue 12 Nov, 1:00–3:00 PM">
            </span>
          </div>
        </div>
      </div>

      <!-- QUOTE PICKER -->
      <div id="quote-pick" class="customer-card" style="display:none;margin-bottom:16px;">
        <div class="customer-header">
          <h3 class="customer-name">Select services & prices to include</h3>
          <div class="customer-actions">
            <button class="btn btn-ghost" id="select-all-quote-items"><i class="fas fa-check-double"></i> Select All</button>
            <button class="btn btn-ghost" id="clear-quote-items"><i class="fas fa-ban"></i> Clear</button>
          </div>
        </div>
        <div id="quote-item-list" class="customer-info" style="row-gap:10px;"></div>
        <p class="muted" id="quote-none" style="display:none;margin-top:8px;">No quotes found for this customer.</p>
      </div>

      <div class="customer-card">
        <div class="form-grid">
          <div class="form-group">
            <label>Subject</label>
            <input id="mail-subject">
          </div>
          <div class="form-group">
            <label>Greeting (optional)</label>
            <input id="mail-greeting" placeholder="Hi John,">
          </div>
        </div>

        <div class="form-group">
          <label>Mail Body</label>
          <textarea id="mail-body" rows="14" style="width:100%;"></textarea>
        </div>

        <div>
          <button class="btn" id="copy-subject"><i class="fas fa-copy"></i> Copy Subject</button>
          <button class="btn" id="copy-body"><i class="fas fa-copy"></i> Copy Body</button>
        </div>
      </div>
    </div>
  </div>

  <!-- SIMPLE CUSTOMER MODAL (unchanged behaviour) -->
  <div id="customer-modal" class="modal" style="display:none"></div>

  <script>
    // ===== Utilities =====
    function esc(s){return String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}
    function val(id){return (document.getElementById(id)?.value||'').trim();}
    function setV(id,v){const el=document.getElementById(id); if(el) el.value=v||'';}
    function showMessage(text,type){const el=document.getElementById('message');el.textContent=text;el.className=`message ${type}`;el.style.display='block';setTimeout(()=>el.style.display='none',3000);}

    let customersCache=[], quotesCache=[];

    auth.onAuthStateChanged(async user=>{
      if(!user){window.location.replace('index.html');return;}
      document.getElementById('current-user-display').textContent=user.email||'Admin';

      // load customers & quotes once
      const cs=await db.collection('musteriler').orderBy('createdAt','desc').get();
      customersCache=cs.docs.map(d=>({id:d.id,...d.data()}));
      renderCustomers();

      const qs=await db.collection('teklifler').orderBy('createdAt','desc').limit(200).get();
      quotesCache=qs.docs.map(d=>({id:d.id,...d.data()}));

      updateQuoteCustomerDropdown();
      updateMailDropdowns();
      initMailUI();
    });

    // ---- TAB NAV ----
    document.querySelectorAll('.nav-btn').forEach(b=>b.addEventListener('click',()=>showSection(b.dataset.section)));
    function showSection(id){
      document.querySelectorAll('.content-section').forEach(s=>s.classList.remove('active'));
      document.querySelector(`.nav-btn[data-section="${id}"]`).classList.add('active');
      document.getElementById(id).classList.add('active');
      if(id==='mail') initMailUI();
    }

    // ---- Customers list (simple) ----
    function renderCustomers(){
      const wrap=document.getElementById('customers-list'); if(!wrap) return;
      wrap.innerHTML = customersCache.map(c=>`
        <div class="customer-card">
          <div class="customer-header"><h3>${esc(c.name||'')}</h3></div>
          <div class="customer-info">
            <div class="info-item"><i class="fas fa-envelope"></i><span>${esc(c.email||'')}</span></div>
            <div class="info-item"><i class="fas fa-phone"></i><span>${esc(c.phone||'')}</span></div>
            <div class="info-item"><i class="fas fa-map-marker-alt"></i><span>${esc(c.address||'')}</span></div>
          </div>
        </div>
      `).join('') || '<p class="muted">No customers.</p>';
    }

    // ---- Quotes (create) dropdown helper ----
    function updateQuoteCustomerDropdown(){
      const sel=document.getElementById('quote-customer'); if(!sel) return;
      const prev=sel.value;
      sel.innerHTML='<option value="">Select Customer</option>'+customersCache.map(c=>`<option value="${c.id}">${esc(c.name||'')}</option>`).join('');
      if(prev) sel.value=prev;
    }

    // ===================== MAIL (ONLY CHANGE) =====================
    function firstNameOf(full){const s=(full||'').trim(); return s? s.split(' ')[0] : '';}
    function currency(n){return `$${Number(n||0).toFixed(2)}`;}

    function updateMailDropdowns(){
      const sel=document.getElementById('mail-customer'); if(!sel) return;
      const prev=sel.value;
      sel.innerHTML='<option value="">Select Customer</option>'+customersCache.map(c=>`<option value="${c.id}">${esc(c.name||'')}</option>`).join('');
      if(prev) sel.value=prev;
    }

    function initMailUI(){
      const typeSel=document.getElementById('mail-type');
      const custSel=document.getElementById('mail-customer');
      const dateWrap=document.getElementById('mail-date-wrap');
      if(!typeSel) return;

      typeSel.onchange=()=>{
        const v=typeSel.value;
        dateWrap.style.display=(v==='booking'||v==='approve')?'flex':'none';
        document.getElementById('quote-pick').style.display=(v==='quote')?'block':'none';
        buildQuotePickList(); buildMailPreview();
      };
      custSel.onchange=()=>{ // Hi {firstname}
        const c=customersCache.find(x=>x.id===custSel.value);
        setV('mail-greeting', c?`Hi ${firstNameOf(c.name)},`:'Hi,');
        buildQuotePickList(); buildMailPreview();
      };
      document.getElementById('mail-date').oninput=buildMailPreview;
      document.getElementById('mail-greeting').oninput=buildMailPreview;
      document.getElementById('copy-subject').onclick=()=>navigator.clipboard.writeText(val('mail-subject'));
      document.getElementById('copy-body').onclick=()=>navigator.clipboard.writeText(val('mail-body'));
      document.getElementById('select-all-quote-items').onclick=()=>{document.querySelectorAll('.mail-qi').forEach(i=>i.checked=true);buildMailPreview();};
      document.getElementById('clear-quote-items').onclick=()=>{document.querySelectorAll('.mail-qi').forEach(i=>i.checked=false);buildMailPreview();};

      // first render
      typeSel.dispatchEvent(new Event('change'));
    }

    // Seçilen müşterinin TÜM kayıtlı tekliflerini getir ve kalemleri (service+total) seçilebilir yap
    function buildQuotePickList(){
      const wrap=document.getElementById('quote-item-list');
      const none=document.getElementById('quote-none');
      const isQuote = document.getElementById('mail-type').value==='quote';
      const customerId = val('mail-customer');

      if(!wrap) return;
      wrap.innerHTML=''; none.style.display='none';
      if(!isQuote || !customerId) return;

      const list = quotesCache.filter(q=>q.customerId===customerId);
      if(!list.length){ none.style.display='block'; return; }

      wrap.innerHTML = list.map(q=>{
        const head = `<div class="pill" style="background:#e9f5ec;border-color:#cfe3d1;"><i class="fas fa-file-invoice-dollar"></i><b>${esc(q.title||'Quote')}</b> — ${currency(q.total||0)}</div>`;
        const body = (q.items||[]).map((it,idx)=>`
          <label class="pill" title="${esc(q.title||'Quote')}">
            <input type="checkbox" class="mail-qi" data-service="${esc(it.service)}" data-total="${Number(it.total||0)}" onchange="buildMailPreview()">
            <span><b>${esc(it.service)}</b> — ${currency(it.total)}</span>
          </label>`).join('');
        return `<div style="grid-column:1/-1;display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin:4px 0 10px 0;">${head}${body}</div>`;
      }).join('');
    }

    function buildMailPreview(){
      const type = val('mail-type');
      const customerId = val('mail-customer');
      const c = customersCache.find(x=>x.id===customerId)||{};
      const greeting = val('mail-greeting') || (c.name?`Hi ${firstNameOf(c.name)},`:'Hi,');
      const whenTxt = val('mail-date');

      let subject='', body='';
      if(type==='quote'){
        subject = `Service Quote — ${c.name||'Customer'}`;
        const items = Array.from(document.querySelectorAll('.mail-qi')).filter(i=>i.checked)
          .map(i=>({service:i.dataset.service,total:Number(i.dataset.total||0)}));
        const lines = items.map(s=>`• ${s.service} — ${currency(s.total)}`).join('\n') || '• (please select services above)';
        body =
`${greeting}

Thanks for getting in touch with Melbourne Lawn & Garden Care.
Based on your request, here are the quote options for your property:

${lines}

If you’d like to proceed, just reply “Approve” and we’ll arrange your booking right away.
(Prices are for the listed services; we can adjust the scope or combine services as needed.)

Kind regards,
Melbourne Lawn & Garden Care
+61 478 733 900`;
      } else if(type==='booking'){
        subject = `Booking Availability — ${c.name||'Customer'}`;
        body =
`${greeting}

We can schedule your lawn & garden service on the following date/time:

${whenTxt||'[your preferred date & time here]'}

Please let us know if this works for you. If not, feel free to suggest another time
and we’ll do our best to accommodate. To confirm, please reply “Approve”.

Kind regards,
Melbourne Lawn & Garden Care
+61 478 733 900`;
      } else if(type==='approve'){
        subject = `Booking Confirmed — ${c.name||'Customer'}`;
        body =
`${greeting}

Your booking has been confirmed. Here are the details:

Date/Time: ${whenTxt||'[confirmed date & time]'}
Address: ${c.address||'[your address]'}
Service: Lawn & garden maintenance (as discussed)

In case of severe weather or any unexpected situation, we’ll contact you in advance.
If you need to reschedule, please let us know and we’ll find a suitable time.

We look forward to providing a great service.

Kind regards,
Melbourne Lawn & Garden Care
+61 478 733 900`;
      } else {
        subject = `Regular Service Offer — 10% off`;
        body =
`${greeting}

We’d be happy to look after your lawn and garden on a regular schedule.
If you choose a regular maintenance plan (weekly, fortnightly, or monthly),
you’ll receive 10% off all ongoing services.

This helps keep your garden consistently neat and healthy — and saves you money.
If you’re interested, just reply and we’ll set up the plan that suits you best.

Kind regards,
Melbourne Lawn & Garden Care
+61 478 733 900`;
      }
      setV('mail-subject',subject);
      setV('mail-body',body);
      if(!val('mail-greeting')) setV('mail-greeting',greeting);
    }

    function logout(){auth.signOut().then(()=>window.location.replace('index.html'))}
  </script>
</body>
</html>
